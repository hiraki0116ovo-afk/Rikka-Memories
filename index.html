<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ChatGPT 对话查看器</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <style>
    @font-face { font-family: "Malvides"; src: url("fonts/Malvides.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "ZLabsBitmap"; src: url("fonts/ZLabsBitmap.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "NaikaiFont"; src: url("fonts/NaikaiFont-Regular.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "MoonStarsKai"; src: url("fonts/MoonStarsKai-Regular.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "MoonStarsKai"; src: url("fonts/MoonStarsKai-Bold.woff2") format("woff2"); font-weight: 700; font-style: normal; font-display: swap; }
    @font-face { font-family: "JasonHandwriting"; src: url("fonts/JasonHandwriting1-Regular.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "JasonHandwriting"; src: url("fonts/JasonHandwriting1-SemiBold.woff2") format("woff2"); font-weight: 600; font-style: normal; font-display: swap; }
    @font-face { font-family: "PingfangShiguang"; src: url("fonts/pingfangshiguang.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "fagun"; src: url("fonts/fagun.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "cococheese"; src: url("fonts/cococheese.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "KURIYAMAKOUCHI"; src: url("fonts/KURIYAMAKOUCHIFONT_N.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    @font-face { font-family: "ZZJmarkpen"; src: url("fonts/ZZJmarkpen.woff2") format("woff2"); font-weight: 400; font-style: normal; font-display: swap; }
    :root {
      --primary: #e8b4b8;
      --primary-dark: #d4a5a5;
      --primary-light: #f5d5d8;
      --bg: #fdf6f6;
      --bg-card: #ffffff;
      --text: #5c4d4d;
      --text-light: #8a7a7a;
      --border: #f0e0e0;
      --user-bubble: #e8b4b8;
      --user-text: #ffffff;
      --ai-bubble: #f8f0f0;
      --ai-text: #5c4d4d;
      --star-active: #f0c14b;
      --heat-1: #fdf0f0;
      --heat-2: #f8d8d8;
      --heat-3: #f0b8b8;
      --heat-4: #e89898;
      --danger: #e57373;
      --danger-light: #ffebee;
      --system-bg: #faf6f1;
      --system-border: #d4c4b0;
      --system-text: #6b5344;
      --memory-bg: #f9f5f0;
      --memory-border: #c9b99a;
      --memory-text: #7a6652;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #fff3cd;
      --highlight-border: #ffdb70;
      --font-size-base: 0.9rem;
      --font-size-small: 0.8rem;
      --font-size-xs: 0.75rem;
      --line-height: 1.6;
      --pattern-color: rgba(232, 180, 184, 0.15);
      --pattern-color-dark: rgba(232, 180, 184, 0.25);
    }
    [data-theme="brown"] {
      --primary: #b5a191;
      --primary-dark: #968272;
      --primary-light: #e0d6cc;
      --bg: #f7f4f1;
      --bg-card: #ffffff;
      --text: #5a524a;
      --text-light: #8c837a;
      --border: #e5ddd5;
      --user-bubble: #b5a191;
      --user-text: #ffffff;
      --ai-bubble: #f3eeea;
      --ai-text: #5a524a;
      --heat-1: #f5f0eb;
      --heat-2: #e8ded4;
      --heat-3: #d4c4b5;
      --heat-4: #b5a191;
      --danger: #c08070;
      --danger-light: #f9eeeb;
      --system-bg: #f3eeea;
      --system-border: #c5b8a8;
      --system-text: #6b5d50;
      --memory-bg: #f3eeea;
      --memory-border: #c5b8a8;
      --memory-text: #6b5d50;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #f5ecd8;
      --highlight-border: #d4c4a8;
      --pattern-color: rgba(181, 161, 145, 0.15);
      --pattern-color-dark: rgba(181, 161, 145, 0.25);
    }
    [data-theme="blue"] {
      --primary: #94A0D3;
      --primary-dark: #7b89c4;
      --primary-light: #d8ddf0;
      --bg: #f5f6fa;
      --bg-card: #ffffff;
      --text: #4a4e69;
      --text-light: #7c8091;
      --border: #e0e3ef;
      --user-bubble: #94A0D3;
      --user-text: #ffffff;
      --ai-bubble: #eef0f8;
      --ai-text: #4a4e69;
      --heat-1: #f0f2f8;
      --heat-2: #d8ddf0;
      --heat-3: #b8c0e0;
      --heat-4: #94A0D3;
      --danger: #d47f8a;
      --danger-light: #faeef0;
      --system-bg: #eef0f8;
      --system-border: #b8c0e0;
      --system-text: #5a5e78;
      --memory-bg: #eef0f8;
      --memory-border: #b8c0e0;
      --memory-text: #5a5e78;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #e8ebf5;
      --highlight-border: #b8c0e0;
      --pattern-color: rgba(148, 160, 211, 0.15);
      --pattern-color-dark: rgba(148, 160, 211, 0.25);
    }
    [data-theme="purple"] {
      --primary: #c4b5d4;
      --primary-dark: #a594b8;
      --primary-light: #e8e0f0;
      --bg: #f9f7fb;
      --bg-card: #ffffff;
      --text: #5a5060;
      --text-light: #8a8090;
      --border: #e8e0f0;
      --user-bubble: #c4b5d4;
      --user-text: #ffffff;
      --ai-bubble: #f3f0f8;
      --ai-text: #5a5060;
      --heat-1: #f5f2f8;
      --heat-2: #e8e0f0;
      --heat-3: #d4c8e0;
      --heat-4: #c4b5d4;
      --danger: #d47f8a;
      --danger-light: #faeef0;
      --system-bg: #f3f0f8;
      --system-border: #c4b5d4;
      --system-text: #6a5a70;
      --memory-bg: #f3f0f8;
      --memory-border: #c4b5d4;
      --memory-text: #6a5a70;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #efe8f5;
      --highlight-border: #d4c8e0;
      --pattern-color: rgba(196, 181, 212, 0.15);
      --pattern-color-dark: rgba(196, 181, 212, 0.25);
    }
    [data-theme="green"] {
      --primary: #a8c5a0;
      --primary-dark: #8fb087;
      --primary-light: #d8e8d4;
      --bg: #f6f9f5;
      --bg-card: #ffffff;
      --text: #4a5648;
      --text-light: #7a8a78;
      --border: #dbe8d8;
      --user-bubble: #a8c5a0;
      --user-text: #ffffff;
      --ai-bubble: #eef4ec;
      --ai-text: #4a5648;
      --heat-1: #f0f5ee;
      --heat-2: #d8e8d4;
      --heat-3: #b8d4b0;
      --heat-4: #a8c5a0;
      --danger: #d47f7f;
      --danger-light: #faeeee;
      --system-bg: #eef4ec;
      --system-border: #a8c5a0;
      --system-text: #5a6858;
      --memory-bg: #eef4ec;
      --memory-border: #a8c5a0;
      --memory-text: #5a6858;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #e8f0e6;
      --highlight-border: #c8d8c4;
      --pattern-color: rgba(168, 197, 160, 0.15);
      --pattern-color-dark: rgba(168, 197, 160, 0.25);
    }
    [data-theme="red"] {
      --primary: #d42b2f;
      --primary-dark: #A20609;
      --primary-light: #fce4e4;
      --bg: #fdf6f6;
      --bg-card: #ffffff;
      --text: #4a1a1a;
      --text-light: #8a4a4a;
      --border: #f0cccc;
      --user-bubble: #c41e22;
      --user-text: #ffffff;
      --ai-bubble: #fdf0f0;
      --ai-text: #4a1a1a;
      --heat-1: #fdf0f0;
      --heat-2: #f5cccc;
      --heat-3: #d45555;
      --heat-4: #A20609;
      --danger: #d47f7f;
      --danger-light: #faeeee;
      --system-bg: #fdf0f0;
      --system-border: #d42b2f;
      --system-text: #6a2a2a;
      --memory-bg: #fdf0f0;
      --memory-border: #d42b2f;
      --memory-text: #6a2a2a;
      --avatar-ai-bg: #ffffff;
      --highlight-bg: #fce8e8;
      --highlight-border: #f0cccc;
      --pattern-color: rgba(162, 6, 9, 0.1);
      --pattern-color-dark: rgba(162, 6, 9, 0.2);
    }
    [data-theme="dark"] {
      --primary: #7c9db8;
      --primary-dark: #5a7a94;
      --primary-light: #3d4a54;
      --bg: #1a1d21;
      --bg-card: #252a30;
      --text: #e0e0e0;
      --text-light: #9a9a9a;
      --border: #3a3f46;
      --user-bubble: #5a7a94;
      --user-text: #ffffff;
      --ai-bubble: #2d3339;
      --ai-text: #e0e0e0;
      --heat-1: #252a30;
      --heat-2: #3d4a54;
      --heat-3: #5a7a94;
      --heat-4: #7c9db8;
      --danger: #cf6679;
      --danger-light: #3d2a2d;
      --system-bg: #2d3339;
      --system-border: #4a5568;
      --system-text: #b0b0b0;
      --memory-bg: #2d3339;
      --memory-border: #4a5568;
      --memory-text: #b0b0b0;
      --avatar-ai-bg: #3d4a54;
      --highlight-bg: #4a4a30;
      --highlight-border: #6a6a40;
      --pattern-color: rgba(124, 157, 184, 0.12);
      --pattern-color-dark: rgba(124, 157, 184, 0.2);
    }
    [data-fontsize="small"] {
      --font-size-base: 0.8rem;
      --font-size-small: 0.7rem;
      --font-size-xs: 0.65rem;
      --line-height: 1.5;
    }
    [data-fontsize="large"] {
      --font-size-base: 1rem;
      --font-size-small: 0.9rem;
      --font-size-xs: 0.85rem;
      --line-height: 1.7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .font-decorative { font-family: 'Malvides', cursive; font-size: 1.2rem; }
    .icon-svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .icon-svg-fill { width: 20px; height: 20px; fill: currentColor; stroke: none; }
    .drawer-menu-item .icon-svg { width: 22px; height: 22px; }
    .title-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; fill: none; vertical-align: middle; margin-right: 6px; }
    .title-icon-fill { width: 24px; height: 24px; fill: var(--star-active); stroke: none; vertical-align: middle; margin-right: 6px; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .loading-overlay.show { opacity: 1; visibility: visible; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 16px; color: var(--text); font-size: var(--font-size-base); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9998; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-card); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
    .modal-overlay.show .modal { transform: scale(1); }
    .modal-icon { font-size: 3rem; margin-bottom: 12px; }
    .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .modal-message { font-size: var(--font-size-base); color: var(--text-light); margin-bottom: 20px; line-height: 1.5; white-space: pre-line; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-size: var(--font-size-base); cursor: pointer; transition: all 0.2s; border: none; }
    .modal-btn.cancel { background: var(--bg); color: var(--text); }
    .modal-btn.confirm { background: var(--danger); color: white; }
    .modal-btn.primary { background: var(--primary); color: white; }
    .modal-btn:active { transform: scale(0.97); }
    .settings-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; max-width: 340px; width: 90%; transform: scale(0.9); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; font-size: 0.9rem; }
    .modal-overlay.show .settings-panel { transform: scale(1); }
    .settings-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .settings-section { margin-bottom: 20px; }
    .settings-label { font-size: var(--font-size-small); color: var(--text-light); margin-bottom: 8px; display: block; }
    .settings-input { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-base); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .settings-input:focus { border-color: var(--primary); }
    .settings-row { display: flex; gap: 12px; }
    .settings-row .settings-field { flex: 1; }
    .theme-selector { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .theme-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: all 0.2s; border: 3px solid transparent; position: relative; }
    .theme-dot:hover { transform: scale(1.1); }
    .theme-dot.active { border-color: var(--text); }
    .theme-dot.active::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    .theme-dot.pink { background: linear-gradient(135deg, #e8b4b8 0%, #d4a5a5 100%); }
    .theme-dot.brown { background: linear-gradient(135deg, #b5a191 0%, #968272 100%); }
    .theme-dot.blue { background: linear-gradient(135deg, #94A0D3 0%, #7b89c4 100%); }
    .theme-dot.purple { background: linear-gradient(135deg, #c4b5d4 0%, #a594b8 100%); }
    .theme-dot.green { background: linear-gradient(135deg, #a8c5a0 0%, #8fb087 100%); }
    .theme-dot.red { background: linear-gradient(135deg, #d42b2f 0%, #A20609 100%); }
    .theme-dot.dark { background: linear-gradient(135deg, #3d4a54 0%, #1a1d21 100%); }
    .fontsize-selector { display: flex; gap: 8px; justify-content: center; align-items: center; }
    .fontsize-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; border-radius: 3px; background: var(--border); outline: none; }
    .fontsize-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; transition: all 0.2s; }
    .fontsize-slider::-webkit-slider-thumb:hover { transform: scale(1.1); background: var(--primary-dark); }
    .fontsize-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; border: none; }
    .font-selector { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-base); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a7a7a' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
    .font-selector:focus { border-color: var(--primary); }
    .settings-buttons { display: flex; gap: 12px; margin-top: 24px; }
    
    /* 背景图案选择器 */
    .pattern-selector { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    .pattern-option { width: 44px; height: 44px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid var(--border); position: relative; overflow: hidden; background: var(--bg-card); }
    .pattern-option:hover { border-color: var(--primary); transform: scale(1.05); }
    .pattern-option.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }
    .pattern-option.active::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary-dark); font-size: 14px; font-weight: bold; z-index: 2; }
    .pattern-option .pattern-preview { width: 100%; height: 100%; }
    /* 无背景 */
    .pattern-option.none .pattern-preview { background: var(--bg); }
    /* 格纹预览 */
    .pattern-option.grid .pattern-preview {
      background-image: 
        linear-gradient(var(--pattern-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--pattern-color) 1px, transparent 1px);
      background-size: 8px 8px;
      background-color: var(--bg);
    }
    /* 波点预览 */
    .pattern-option.dots .pattern-preview {
      background-image: radial-gradient(var(--pattern-color-dark) 2px, transparent 2px);
      background-size: 8px 8px;
      background-position: 0 0, 4px 4px;
      background-color: var(--bg);
    }
    /* 条纹预览 */
    .pattern-option.stripes .pattern-preview {
      background-image: repeating-linear-gradient(
        90deg,
        var(--pattern-color) 0px,
        var(--pattern-color) 4px,
        transparent 4px,
        transparent 8px
      );
      background-color: var(--bg);
    }
    /* 自定义背景选项 */
    .pattern-option.custom .pattern-preview { background: var(--bg); display: flex; align-items: center; justify-content: center; }
    .pattern-option.custom .pattern-preview svg { width: 20px; height: 20px; stroke: var(--text-light); stroke-width: 1.5; fill: none; }
    .pattern-option.custom.has-image .pattern-preview { background-size: cover; background-position: center; }
    .pattern-option.custom.has-image .pattern-preview svg { display: none; }
    .pattern-option.custom.active.has-image::after { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
    .pattern-option.custom .bg-delete { position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: var(--danger); color: white; border-radius: 50%; font-size: 10px; display: none; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 3; }
    .pattern-option.custom.has-image:hover .bg-delete { display: flex; }
    .pattern-label { font-size: 0.6rem; text-align: center; margin-top: 2px; color: var(--text-light); }
    
    /* 头像上传 */
    .avatar-upload-section { display: flex; gap: 16px; justify-content: center; }
    .avatar-upload-item { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .avatar-upload-preview { width: 56px; height: 56px; border-radius: 50%; border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--bg); cursor: pointer; transition: all 0.2s; overflow: visible; position: relative; }
    .avatar-upload-preview img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .avatar-upload-preview:hover { border-color: var(--primary); background: var(--primary-light); }
    .avatar-upload-preview img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload-preview .avatar-delete { position: absolute; top: -4px; right: -4px; width: 18px; height: 18px; background: var(--danger); color: white; border-radius: 50%; font-size: 12px; display: none; align-items: center; justify-content: center; cursor: pointer; line-height: 1; }
    .avatar-upload-preview:hover .avatar-delete { display: flex; }
    .avatar-upload-label { font-size: var(--font-size-xs); color: var(--text-light); }
    .avatar-upload-input { display: none; }
    
    /* Header */
    .header { 
      position: fixed; top: 0; left: 0; right: 0; height: 56px; 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 0 12px; z-index: 1000; 
    }
    .header-left { display: flex; align-items: center; gap: 6px; }
    .header-btn { width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-weight: 500; }
    .header-btn:hover { background: rgba(255,255,255,0.3); }
    .header-btn:active { transform: scale(0.95); }
    .header-btn .icon-svg { stroke: white; }
    .header-logo { font-size: 1.4rem; font-weight: 600; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1); letter-spacing: 0.5px; white-space: nowrap; font-family: "fagun", -apple-system, BlinkMacSystemFont, sans-serif; }
    @media (max-width: 380px) { .header-logo { font-size: 0.95rem; } }
    .drawer-header h2 { font-family: "fagun", -apple-system, BlinkMacSystemFont, sans-serif; }
    .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1001; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .drawer-overlay.show { opacity: 1; visibility: visible; }
    .drawer { position: fixed; top: 0; left: 0; width: 300px; max-width: 85vw; height: 100%; background: var(--bg-card); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; }
    .drawer.show { transform: translateX(0); }
    .drawer-header { padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
    .drawer-header h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .drawer-header p { font-size: var(--font-size-xs); opacity: 0.9; }
    .drawer-menu { display: flex; padding: 8px 10px; gap: 4px; border-bottom: 1px solid var(--border); background: var(--bg); }
    .drawer-menu-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px 2px; cursor: pointer; transition: all 0.2s; border-radius: 8px; gap: 3px; color: var(--text); }
    .drawer-menu-item:hover { background: var(--primary-light); }
    .drawer-menu-item.active { background: var(--primary-light); color: var(--primary-dark); }
    .drawer-menu-item .label { font-size: 0.6rem; white-space: nowrap; }
    .drawer-menu-item.danger { color: var(--danger); }
    .drawer-menu-item.danger:hover { background: var(--danger-light); }
    .conv-actions { display: flex; align-items: center; padding: 8px 10px; gap: 6px; border-bottom: 1px solid var(--border); }
    .conv-action-btn { flex: 1; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 3px; color: var(--text); }
    .conv-action-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .conv-action-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .conv-action-btn.danger { color: var(--danger); }
    .conv-action-btn.danger:hover { background: var(--danger-light); border-color: var(--danger); }
    .conv-search { padding: 8px 10px; }
    .conv-search input { width: 100%; padding: 8px 12px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-small); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .conv-search input:focus { border-color: var(--primary); }
    .conv-search input::placeholder { color: var(--text-light); }
    .drawer-conversations { flex: 1; overflow-y: auto; padding: 8px 10px; }
    .conv-item, .conv-checkbox, .conv-action-btn, .drawer-menu-item, .star-btn, .export-format-btn, .fav-msg-checkbox, .fav-action-btn, .msg-copy-btn, .fav-jump-btn, .modal-btn, .conv-delete-btn, .message-bubble, .search-result-item, .header-btn, .upload-btn { touch-action: manipulation; }
    .conv-item { padding: 10px 12px; border-radius: 10px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; background: var(--bg); display: flex; align-items: flex-start; gap: 8px; }
    .conv-item:hover { border-color: var(--primary-light); }
    .conv-item.active { border-color: var(--primary); background: var(--primary-light); }
    .conv-item.selected { border-color: var(--primary); background: var(--primary-light); }
    .conv-checkbox { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px; display: none; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; background: white; transition: all 0.2s; font-size: 0.7rem; }
    .conv-checkbox.show { display: flex; }
    .conv-checkbox.checked { background: var(--primary); border-color: var(--primary); color: white; }
    .conv-info { flex: 1; min-width: 0; }
    .conv-item .conv-title { font-size: var(--font-size-small); font-weight: 500; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-item .conv-meta { font-size: var(--font-size-xs); color: var(--text-light); line-height: 1.4; }
    .conv-delete-btn { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-light); border-radius: 6px; cursor: pointer; display: none; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; font-size: 1rem; }
    .conv-item:hover .conv-delete-btn { display: flex; }
    .conv-delete-btn:hover { background: var(--danger-light); color: var(--danger); }
    .main-content { padding-top: 56px; min-height: 100vh; background: var(--bg); }
    .view-upload { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 64px); padding: 20px; }
    .upload-box { background: var(--bg-card); border-radius: 24px; padding: 50px 40px; text-align: center; border: 3px dashed var(--primary-light); max-width: 400px; width: 100%; transition: all 0.3s; }
    .upload-box.dragover { border-color: var(--primary); background: var(--primary-light); }
    .upload-box .icon { font-size: 4rem; margin-bottom: 16px; }
    .upload-box h2 { font-size: 1.2rem; color: var(--text); margin-bottom: 8px; font-weight: 500; }
    .upload-box p { font-size: var(--font-size-small); color: var(--text-light); margin-bottom: 24px; }
    .upload-btn { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; padding: 14px 32px; border-radius: 25px; font-size: 1rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(232, 180, 184, 0.4); }
    .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(232, 180, 184, 0.5); }
    #file-input { display: none; }
    .upload-hint { margin-top: 20px; padding: 12px 16px; background: var(--primary-light); border-radius: 12px; font-size: var(--font-size-small); color: var(--text); }
    .view-chat { display: none; flex-direction: column; height: calc(100vh - 64px); }
    .view-chat.show { display: flex; }
    .chat-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .chat-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .chat-title { font-size: 1rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .collapse-btn { width: 28px; height: 28px; border: none; background: var(--bg); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-light); font-size: 0.8rem; margin-left: 8px; flex-shrink: 0; }
    .collapse-btn:hover { background: var(--primary-light); color: var(--primary-dark); }
    .collapse-btn.collapsed { transform: rotate(180deg); }
    .collapsible-section { transition: all 0.3s ease; overflow: hidden; }
    .collapsible-section.collapsed { height: 0 !important; padding: 0 !important; margin: 0 !important; opacity: 0; }
    .search-section { margin-bottom: 8px; }
    .search-box { position: relative; }
    .search-box input { width: 100%; padding: 10px 44px 10px 16px; border: 2px solid var(--border); border-radius: 20px; font-size: var(--font-size-base); outline: none; transition: all 0.2s; background: var(--bg); color: var(--text); }
    .search-box input:focus { border-color: var(--primary); background: var(--bg-card); }
    .search-box input::placeholder { color: var(--text-light); }
    .search-box .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
    
    .search-box .search-submit-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; padding: 6px 8px; border-radius: 10px; font-size: 16px; line-height: 1; color: var(--text-light); transition: all 0.2s; }
    .search-box .search-submit-btn:hover { background: var(--primary-light); color: var(--primary-dark); }
    .search-box .search-submit-btn:active { transform: translateY(-50%) scale(0.98); }
.search-mode-toggle { display: flex; gap: 4px; margin-top: 8px; }
    .search-mode-btn { flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 15px; background: var(--bg); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--text); }
    .search-mode-btn:hover { border-color: var(--primary); }
    .search-mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .global-search-info { display: none; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--primary-light); border-radius: 10px; margin-top: 8px; font-size: var(--font-size-small); }
    .global-search-info.show { display: flex; }
    .search-result-count { color: var(--primary-dark); font-weight: 500; }
    .search-nav-btns { display: flex; gap: 4px; }
    .search-nav-btn { padding: 4px 10px; border: 1px solid var(--primary); border-radius: 12px; background: white; font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--primary-dark); }
    .search-nav-btn:hover { background: var(--primary); color: white; }
    .timeline-nav { display: none; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); overflow-x: auto; white-space: nowrap; gap: 8px; }
    .timeline-nav.show { display: flex; }
    .timeline-nav.collapsed { display: none !important; }
    .timeline-btn { display: inline-block; padding: 6px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 15px; font-size: var(--font-size-small); color: var(--text); cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .timeline-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    
    /* 聊天消息区域背景 */
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); position: relative; }
    
    /* 背景图案样式 */
    .chat-messages[data-pattern="grid"] {
      background-image: 
        linear-gradient(var(--pattern-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--pattern-color) 1px, transparent 1px);
      background-size: 12px 12px;
      background-color: var(--bg);
    }
    .chat-messages[data-pattern="dots"] {
      background-image: 
        radial-gradient(var(--pattern-color-dark) 4px, transparent 4px),
        radial-gradient(var(--pattern-color-dark) 4px, transparent 4px);
      background-size: 28px 28px;
      background-position: 0 0, 14px 14px;
      background-color: var(--bg);
    }
    .chat-messages[data-pattern="stripes"] {
      background-image: repeating-linear-gradient(
        90deg,
        var(--pattern-color) 0px,
        var(--pattern-color) 10px,
        transparent 10px,
        transparent 20px
      );
      background-color: var(--bg);
    }
    /* 自定义背景图片 - 固定不滚动 */
    .chat-messages[data-pattern="custom"] {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    
    .date-divider { text-align: center; margin: 20px 0; position: relative; }
    .date-divider span { background: var(--bg); padding: 4px 16px; font-size: var(--font-size-small); color: var(--text-light); border-radius: 12px; }
    .chat-messages[data-pattern] .date-divider span { background: var(--bg-card); }
    .conv-group-title { background: var(--primary-light); padding: 8px 14px; border-radius: 10px; margin: 16px 0 12px; font-size: var(--font-size-small); font-weight: 500; color: var(--primary-dark); display: flex; align-items: center; gap: 6px; }
    .message { display: flex; margin-bottom: 16px; align-items: flex-start; }
    .message.user { flex-direction: row-reverse; }
    .message-avatar-wrapper { display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
    .message.user .message-avatar-wrapper { margin-left: 10px; }
    .message.assistant .message-avatar-wrapper, .message.system .message-avatar-wrapper, .message.memory .message-avatar-wrapper { margin-right: 10px; }
    .message-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; background: var(--bg); }
    .message.user .message-avatar { background: var(--primary-light); }
    .message.assistant .message-avatar { background: var(--avatar-ai-bg); }
    .message.system .message-avatar { background: var(--system-bg); }
    .message.memory .message-avatar { background: var(--memory-bg); }
    .avatar-name { font-size: 0.55rem; color: var(--text-light); margin-top: 4px; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
    .message-body { max-width: 75%; position: relative; }
    .message-bubble { padding: 12px 16px; border-radius: 18px; line-height: var(--line-height); font-size: var(--font-size-base); word-break: break-word; white-space: pre-wrap; }
    .message.user .message-bubble { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 6px; }
    .message.assistant .message-bubble { background: var(--ai-bubble); color: var(--ai-text); border-bottom-left-radius: 6px; }
    .message.highlight .message-bubble { box-shadow: 0 0 0 3px var(--primary); }
    .highlight-text { background: var(--highlight-bg); padding: 1px 2px; border-radius: 2px; }
    .message-bubble .highlight { background: var(--highlight-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--highlight-border); font-weight: 500; }
    .search-result-preview .highlight { background: var(--highlight-bg); padding: 1px 3px; border-radius: 2px; font-weight: 500; }
    .message.system .message-bubble { background: var(--system-bg); color: var(--system-text); border: 1px solid var(--system-border); border-bottom-left-radius: 6px; }
    .message.system .message-bubble .system-label { display: inline-block; background: var(--system-border); color: white; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); margin-bottom: 8px; font-weight: 500; }
    .message.memory .message-bubble { background: var(--memory-bg); color: var(--memory-text); border: 1px solid var(--memory-border); border-bottom-left-radius: 6px; }
    .message.memory .message-bubble .memory-label { display: inline-block; background: var(--memory-border); color: white; padding: 2px 8px; border-radius: 4px; font-size: var(--font-size-xs); margin-bottom: 8px; font-weight: 500; }
    .message-footer { display: flex; align-items: center; gap: 8px; margin-top: 4px; padding: 0 4px; flex-wrap: wrap; }
    .message.user .message-footer { flex-direction: row-reverse; }
    .message-time { font-size: var(--font-size-xs); color: var(--text-light); }
    .message-model { font-size: 0.65rem; color: var(--primary-dark); background: var(--primary-light); padding: 2px 6px; border-radius: 4px; }
    .star-btn { background: none; border: none; cursor: pointer; font-size: 1rem; opacity: 0.4; transition: all 0.2s; padding: 2px; }
    .star-btn:hover { opacity: 0.8; }
    .star-btn.active { opacity: 1; color: var(--star-active); }
    .view-global-search { display: none; flex-direction: column; height: calc(100vh - 64px); }
    .view-global-search.show { display: flex; }
    .global-search-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .global-search-title { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .global-search-title h2 { font-size: 1rem; font-weight: 500; flex: 1; }
    .global-search-back { width: 32px; height: 32px; border: none; background: var(--bg); border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text); }
    .global-search-back:hover { background: var(--primary-light); }
    .global-search-stats { font-size: var(--font-size-small); color: var(--text-light); }
    .global-search-results { flex: 1; overflow-y: auto; padding: 12px 16px; }
    .search-result-item { background: var(--bg-card); border-radius: 12px; padding: 12px 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .search-result-item:hover { border-color: var(--primary-light); }
    .search-result-conv-title { font-size: var(--font-size-small); font-weight: 500; color: var(--primary-dark); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .search-result-count-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: var(--font-size-xs); font-weight: normal; }
    .search-result-preview { font-size: var(--font-size-small); color: var(--text); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .search-result-meta { font-size: var(--font-size-xs); color: var(--text-light); margin-top: 6px; }
    .view-favorites { display: none; flex-direction: column; height: calc(100vh - 64px); }
    .view-favorites.show { display: flex; }
    .favorites-header { padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
    .favorites-header .view-title { margin-bottom: 12px; }
    .favorites-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .fav-action-btn { padding: 8px 14px; border: 1px solid var(--border); border-radius: 20px; background: var(--bg); font-size: var(--font-size-small); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; color: var(--text); }
    .fav-action-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .fav-action-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .fav-action-btn.export { background: var(--primary); color: white; border-color: var(--primary); }
    .fav-action-btn.export:hover { background: var(--primary-dark); }
    .fav-action-btn.danger { color: var(--danger); border-color: var(--danger); }
    .fav-action-btn.danger:hover { background: var(--danger-light); }
    .favorites-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .fav-msg-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%; display: none; align-items: center; justify-content: center; flex-shrink: 0; background: white; transition: all 0.2s; font-size: 0.7rem; cursor: pointer; margin-right: 8px; }
    .fav-msg-checkbox.show { display: flex; }
    .fav-msg-checkbox.checked { background: var(--primary); border-color: var(--primary); color: white; }
    .fav-jump-btn { background: none; border: 1px solid var(--border); border-radius: 12px; padding: 2px 8px; font-size: var(--font-size-xs); color: var(--text-light); cursor: pointer; transition: all 0.2s; margin-left: 8px; }
    .fav-jump-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
    .view-title { font-size: 1.2rem; font-weight: 500; padding-bottom: 12px; border-bottom: 2px solid var(--primary-light); display: flex; align-items: center; }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-state .icon { font-size: 3.5rem; margin-bottom: 12px; }
    .view-stats { display: none; padding: 16px; overflow-y: auto; height: calc(100vh - 64px); background: var(--bg); }
    .view-stats.show { display: block; }
    .stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .month-nav { display: flex; align-items: center; gap: 12px; }
    .month-nav button { background: var(--bg-card); border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1rem; transition: all 0.2s; color: var(--text); }
    .month-nav button:hover { background: var(--primary-light); border-color: var(--primary); }
    .month-nav .month-label { font-size: 1rem; font-weight: 500; min-width: 120px; text-align: center; }
    /* 图表切换按钮 */
    .chart-toggle { display: flex; gap: 4px; background: var(--bg); border-radius: 20px; padding: 4px; }
    .chart-toggle-btn { width: 36px; height: 36px; border: none; background: transparent; border-radius: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-light); }
    .chart-toggle-btn:hover { color: var(--primary-dark); }
    .chart-toggle-btn.active { background: var(--primary); color: white; }
    .chart-toggle-btn svg { width: 18px; height: 18px; }
    /* 折线图容器 */
    .line-chart-container { background: var(--bg-card); border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: none; max-width: 600px; margin: 0 auto; }
    .line-chart-container.show { display: block; }
    .line-chart-canvas { width: 100%; height: 200px; }
    .calendar { background: var(--bg-card); border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px; }
    .calendar-weekdays span { text-align: center; font-size: var(--font-size-xs); color: var(--text-light); padding: 8px 0; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; font-size: var(--font-size-small); cursor: pointer; transition: all 0.2s; background: var(--bg); }
    .calendar-day:hover { transform: scale(1.05); }
    .calendar-day.empty { background: transparent; cursor: default; }
    .calendar-day.empty:hover { transform: none; }
    .calendar-day .day-num { font-weight: 500; }
    .calendar-day .day-words { font-size: 0.6rem; color: var(--text-light); margin-top: 2px; }
    .calendar-day.heat-1 { background: var(--heat-1); }
    .calendar-day.heat-2 { background: var(--heat-2); }
    .calendar-day.heat-3 { background: var(--heat-3); }
    .calendar-day.heat-4 { background: var(--heat-4); color: white; }
    .calendar-day.heat-4 .day-words { color: rgba(255,255,255,0.8); }
    .stats-summary { margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .stat-card .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--primary-dark); }
    .stat-card .stat-label { font-size: var(--font-size-small); color: var(--text-light); margin-top: 4px; }

    /* 总数据统计对比卡片 - 错位布局 */
    .total-stats-section { margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border); position: relative; min-height: 180px; }
    .total-stats-card {
      width: 65%;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      display: flex;
      align-items: flex-start;
      gap: 14px;
      position: relative;
    }
    .total-stats-card.assistant {
      margin-left: 0;
      margin-right: auto;
      flex-direction: row;
    }
    .total-stats-card.user {
      margin-left: auto;
      margin-right: 0;
      margin-top: 16px;
      flex-direction: row-reverse;
    }
    .total-stats-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }
    .total-stats-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      background: var(--bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .total-stats-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .total-stats-name { font-size: 0.75rem; font-weight: 600; color: var(--text); margin-top: 6px; text-align: center; }
    .total-stats-data { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    .total-stats-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background: var(--bg); border-radius: 8px; }
    .total-stats-row .label { font-size: 0.7rem; color: var(--text-light); }
    .total-stats-row .value { font-size: 0.8rem; font-weight: 600; color: var(--primary-dark); }
    @media (max-width: 400px) {
      .total-stats-card { width: 85%; }
    }

    /* 聊天总览区域 */
    .chat-overview-section { margin-top: 20px; }
    .overview-summary { background: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 16px; }
    .overview-text { font-size: var(--font-size-base); line-height: 1.8; color: var(--text); margin: 0; }
    .overview-text .highlight-num { color: var(--primary-dark); font-weight: 600; }
    .overview-actions { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: nowrap; align-items: center; }
    .overview-action-btn { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--text); display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .overview-action-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
    .random-moment-wrapper { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .random-moment-hint { font-size: var(--font-size-xs); color: var(--primary); opacity: 0.7; font-style: italic; }
    .overview-rankings { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: stretch; }
    @media (max-width: 500px) { .overview-rankings { grid-template-columns: 1fr 1fr; gap: 8px; } }
    .ranking-card { background: var(--bg-card); border-radius: 12px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
    .ranking-title { font-size: 0.75rem; font-weight: 600; color: var(--text); margin-bottom: 2px; }
    .ranking-subtitle { font-size: 0.65rem; color: var(--text-light); margin-bottom: 8px; }
    .ranking-list { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .ranking-item { display: flex; align-items: center; padding: 5px 6px; background: var(--bg); border-radius: 8px; cursor: pointer; transition: all 0.2s; gap: 4px; }
    .ranking-item:hover { background: var(--primary-light); transform: translateX(2px); }
    .ranking-item .rank-num { font-size: 0.65rem; font-weight: 600; color: var(--primary-dark); min-width: 18px; }
    .ranking-item .rank-info { flex: 1; min-width: 0; }
    .ranking-item .rank-title { font-size: 0.65rem; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ranking-item .rank-meta { font-size: 0.6rem; color: var(--text-light); margin-top: 1px; }
    /* 词云区域 */
    .wordcloud-section { margin-top: 20px; }
    .wordcloud-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
    .wordcloud-title { font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .wordcloud-title svg { width: 20px; height: 20px; fill: var(--primary); }
    .wordcloud-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .wordcloud-filter { padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: var(--font-size-xs); background: var(--bg); color: var(--text); outline: none; max-width: 120px; }
    .wordcloud-filter:focus { border-color: var(--primary); }
    .blacklist-btn { padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); font-size: var(--font-size-xs); cursor: pointer; transition: all 0.2s; color: var(--text); display: flex; align-items: center; gap: 4px; }
    .blacklist-btn:hover { background: var(--primary-light); border-color: var(--primary); }
    .wordcloud-block-row { display: flex; align-items: center; gap: 8px; }
    .wordcloud-checkbox-label { display: flex; align-items: center; gap: 6px; font-size: var(--font-size-xs); color: var(--text); cursor: pointer; padding: 6px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); transition: all 0.2s; }
    .wordcloud-checkbox-label:hover { border-color: var(--primary); background: var(--primary-light); }
    .wordcloud-checkbox-label input[type="checkbox"] { display: none; }
    .wordcloud-checkbox-label .custom-checkbox { width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 10px; color: white; }
    .wordcloud-checkbox-label input[type="checkbox"]:checked + .custom-checkbox { background: var(--primary); border-color: var(--primary); }
    .wordcloud-checkbox-label input[type="checkbox"]:checked + .custom-checkbox::after { content: '✓'; }
    .wordcloud-container { background: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 150px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center; }
    .wordcloud-word { padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s; white-space: nowrap; position: relative; display: inline-flex; align-items: center; gap: 2px; }
    .wordcloud-word:hover { transform: scale(1.1); opacity: 0.8; }
    .wordcloud-word .word-delete-btn { display: none; width: 14px; height: 14px; background: var(--danger); color: white; border-radius: 50%; font-size: 10px; line-height: 14px; text-align: center; margin-left: 4px; cursor: pointer; flex-shrink: 0; }
    .wordcloud-word.show-delete .word-delete-btn { display: inline-block; }
    .wordcloud-word.show-delete { padding-right: 8px; }
    .wordcloud-word.size-1 { font-size: 0.75rem; background: var(--heat-1); color: var(--text); }
    .wordcloud-word.size-2 { font-size: 0.85rem; background: var(--heat-2); color: var(--text); }
    .wordcloud-word.size-3 { font-size: 1rem; background: var(--heat-3); color: var(--text); font-weight: 500; }
    .wordcloud-word.size-4 { font-size: 1.15rem; background: var(--heat-4); color: white; font-weight: 500; }
    .wordcloud-word.size-5 { font-size: 1.3rem; background: var(--primary); color: white; font-weight: 600; }
    .wordcloud-empty { color: var(--text-light); font-size: var(--font-size-small); }
    /* 黑名单管理弹窗 */
    .blacklist-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; max-width: 340px; width: 90%; transform: scale(0.9); transition: transform 0.3s; max-height: 70vh; display: flex; flex-direction: column; }
    .modal-overlay.show .blacklist-panel { transform: scale(1); }
    .blacklist-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .blacklist-add { display: flex; gap: 8px; margin-bottom: 16px; }
    .blacklist-input { flex: 1; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: var(--font-size-base); outline: none; background: var(--bg); color: var(--text); }
    .blacklist-input:focus { border-color: var(--primary); }
    .blacklist-add-btn { padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: var(--font-size-base); transition: all 0.2s; }
    .blacklist-add-btn:hover { background: var(--primary-dark); }
    .blacklist-list { flex: 1; overflow-y: auto; max-height: 300px; }
    .blacklist-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: var(--bg); border-radius: 8px; margin-bottom: 6px; }
    .blacklist-item-word { font-size: var(--font-size-base); color: var(--text); }
    .blacklist-item-delete { width: 24px; height: 24px; border: none; background: transparent; color: var(--danger); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .blacklist-item-delete:hover { background: var(--danger-light); }
    .view-timeline { display: none; padding: 16px; overflow-y: auto; height: calc(100vh - 64px); background: var(--bg); }
    .view-timeline.show { display: block; }
    .timeline-list { background: var(--bg-card); border-radius: 16px; overflow: hidden; }
    .timeline-date-item { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .timeline-date-item:last-child { border-bottom: none; }
    .timeline-date-item:hover { background: var(--bg); }
    .timeline-date-item .date { font-weight: 500; flex: 1; }
    .timeline-date-item .count { font-size: var(--font-size-small); color: var(--text-light); }
    .view-conv-select { display: none; flex-direction: column; height: calc(100vh - 64px); }
    .view-conv-select.show { display: flex; }
    .conv-select-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); }
    .conv-select-item { display: flex; align-items: center; padding: 14px 16px; background: var(--bg-card); border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .conv-select-item:hover { border-color: var(--primary-light); transform: translateX(4px); }
    .conv-select-item:active { transform: scale(0.98); }
    .conv-select-item .conv-icon { font-size: 1.5rem; margin-right: 12px; }
    .conv-select-item .conv-detail { flex: 1; min-width: 0; }
    .conv-select-item .conv-name { font-size: var(--font-size-base); font-weight: 500; color: var(--text); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .conv-select-item .conv-stats { font-size: var(--font-size-xs); color: var(--text-light); }
    .conv-select-item .conv-arrow { color: var(--text-light); font-size: 1.2rem; }
    .view-day-messages { display: none; flex-direction: column; height: calc(100vh - 64px); }
    .view-day-messages.show { display: flex; }
    .day-header { padding: 12px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .day-back-btn { width: 36px; height: 36px; border: none; background: var(--bg); border-radius: 10px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text); }
    .day-back-btn:hover { background: var(--primary-light); }
    .day-title { flex: 1; }
    .day-title h2 { font-size: 1rem; font-weight: 500; margin-bottom: 2px; }
    .day-title p { font-size: var(--font-size-xs); color: var(--text-light); }
    .day-messages { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg); position: relative; }
    /* day-messages 背景图案样式 */
    .day-messages[data-pattern="grid"] {
      background-image: 
        linear-gradient(var(--pattern-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--pattern-color) 1px, transparent 1px);
      background-size: 12px 12px;
      background-color: var(--bg);
    }
    .day-messages[data-pattern="dots"] {
      background-image: 
        radial-gradient(var(--pattern-color-dark) 4px, transparent 4px),
        radial-gradient(var(--pattern-color-dark) 4px, transparent 4px);
      background-size: 28px 28px;
      background-position: 0 0, 14px 14px;
      background-color: var(--bg);
    }
    .day-messages[data-pattern="stripes"] {
      background-image: repeating-linear-gradient(
        90deg,
        var(--pattern-color) 0px,
        var(--pattern-color) 10px,
        transparent 10px,
        transparent 20px
      );
      background-color: var(--bg);
    }
    .day-messages[data-pattern="custom"] {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .day-messages[data-pattern] .date-divider span { background: var(--bg-card); }
    .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(92, 77, 77, 0.9); color: white; padding: 12px 24px; border-radius: 25px; font-size: var(--font-size-base); z-index: 9999; opacity: 0; transition: all 0.3s; }
    [data-theme="dark"] .toast { background: rgba(200, 200, 200, 0.9); color: #1a1d21; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .export-format-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; max-width: 300px; width: 90%; transform: scale(0.9); transition: transform 0.3s; }
    .modal-overlay.show .export-format-panel { transform: scale(1); }
    .export-format-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); text-align: center; }
    .export-format-options { display: flex; flex-direction: column; gap: 10px; }
    .export-format-btn { padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); font-size: var(--font-size-base); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; color: var(--text); }
    .export-format-btn:hover { border-color: var(--primary); background: var(--primary-light); }
    .export-format-btn .format-icon { font-size: 1.3rem; }
    .export-format-btn .format-info { flex: 1; text-align: left; }
    .export-format-btn .format-name { font-weight: 500; }
    .export-format-btn .format-desc { font-size: var(--font-size-xs); color: var(--text-light); margin-top: 2px; }
    @media (max-width: 480px) { .header-logo { font-size: 1.1rem; } .message-body { max-width: 85%; } .upload-box { padding: 30px 20px; } }
  
    /* Markdown rendering inside bubbles */
    .message-bubble { white-space: normal; }
    .message-bubble p { margin: 0.4em 0; }
    .message-bubble p:first-child { margin-top: 0; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4, .message-bubble h5, .message-bubble h6 {
      margin: 0.7em 0 0.35em;
      line-height: 1.25;
      font-weight: 650;
    }
    .message-bubble ul, .message-bubble ol { margin: 0.4em 0; padding-left: 1.2em; }
    .message-bubble li { margin: 0.15em 0; }
    .message-bubble blockquote {
      margin: 0.4em 0;
      padding: 0.1em 0 0.1em 0.8em;
      border-left: 3px solid rgba(0,0,0,0.18);
      opacity: 0.95;
    }
    [data-theme="dark"] .message-bubble blockquote { border-left-color: rgba(255,255,255,0.22); }
    .message-bubble pre {
      margin: 0.55em 0;
      padding: 10px 12px;
      border-radius: 12px;
      overflow: auto;
      background: rgba(0,0,0,0.06);
    }
    [data-theme="dark"] .message-bubble pre { background: rgba(255,255,255,0.08); }
    .message-bubble code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
    }
    .message-bubble pre code { white-space: pre; }
    .message-bubble a { color: var(--primary); text-decoration: underline; }
    mark.kw-highlight { background: var(--highlight-bg); padding: 1px 2px; border-radius: 2px; }

    /* 代码块复制按钮 */
    .code-block-wrapper { position: relative; }
    .code-block-wrapper .code-copy-btn { position: absolute; top: 6px; right: 6px; z-index: 10; }
    .code-copy-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: rgba(255,255,255,0.85);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      color: var(--text);
      font-size: 0.75rem;
      padding: 0;
    }
    .code-block-wrapper:hover .code-copy-btn { opacity: 0.7; }
    .code-copy-btn:hover { opacity: 1 !important; background: rgba(255,255,255,1); }
    .code-copy-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; }
    .code-copy-btn.copied { color: #22c55e; }
    .code-copy-btn.copied svg { stroke: #22c55e; }
    [data-theme="dark"] .code-copy-btn { background: rgba(60,60,60,0.85); }
    [data-theme="dark"] .code-copy-btn:hover { background: rgba(80,80,80,1); }

    /* 消息复制按钮 */
    .msg-copy-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 6px;
      opacity: 0.4;
      transition: all 0.2s;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .msg-copy-btn:hover { opacity: 1; color: var(--primary-dark); }
    .msg-copy-btn svg { width: 14px; height: 14px; stroke: currentColor; fill: none; }
    .msg-copy-btn.copied { color: #22c55e; }
    .msg-copy-btn.copied svg { stroke: #22c55e; }

    /* 消息删除按钮优化 - X图标放右上角 */
    .message-body { position: relative; }
    .msg-delete-x {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border: none;
      background: var(--danger-light);
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--danger);
      transition: all 0.2s;
      z-index: 10;
      line-height: 1;
    }
    .msg-delete-x:hover { background: var(--danger); color: white; }
    .message.show-delete .msg-delete-x { display: flex; }

    /* 触屏设备：禁用hover效果，解决Safari双击问题 */
    .load-more-container { text-align: center; padding: 20px 16px 40px; }
    .load-more-btn { padding: 12px 32px; border: 2px solid var(--primary); border-radius: 24px; background: var(--bg-card); color: var(--primary-dark); font-size: var(--font-size-base); cursor: pointer; transition: all 0.2s; font-weight: 500; }
    .load-more-btn:active { background: var(--primary); color: white; }
    @media (hover: none) and (pointer: coarse) {
      .conv-item:hover { border-color: transparent; }
      .conv-item:hover .conv-delete-btn { display: none; }
      .drawer-menu-item:hover { background: transparent; }
      .drawer-menu-item.danger:hover { background: transparent; }
      .conv-action-btn:hover { background: var(--bg); border-color: var(--border); }
      .conv-action-btn.danger:hover { background: transparent; border-color: var(--border); }
      .header-btn:hover { background: transparent; }
      .upload-btn:hover { transform: none; box-shadow: none; }
      .star-btn:hover { opacity: 1; }
      .search-result-item:hover { border-color: var(--border); }
      .fav-action-btn:hover { background: var(--bg); border-color: var(--border); }
      .fav-action-btn.export:hover { background: var(--primary); }
      .fav-action-btn.danger:hover { background: transparent; }
      .fav-jump-btn:hover { background: transparent; border-color: var(--border); color: var(--text-light); }
      .conv-delete-btn:hover { background: transparent; color: var(--text-light); }
      .export-format-btn:hover { border-color: var(--border); background: var(--bg); }
      .collapse-btn:hover { background: transparent; color: var(--text-light); }
      .search-mode-btn:hover { border-color: var(--border); }
      .search-nav-btn:hover { background: var(--primary-light); color: var(--primary); }
      .timeline-btn:hover { background: var(--bg); border-color: var(--border); }
      .month-nav button:hover { background: var(--bg); border-color: var(--border); }
      .global-search-back:hover { background: transparent; }
      .pattern-option:hover { border-color: var(--border); transform: none; }
      .theme-dot:hover { transform: none; }
      .chart-toggle-btn:hover { color: var(--text-light); }
      .calendar-day:hover { transform: none; }
    }
    /* Safari工具栏收起时fixed遮罩高度修复 */
    @supports (-webkit-touch-callout: none) {
      .drawer { height: 100dvh; }
      .drawer-overlay { height: 100dvh; }
      .modal-overlay { height: 100dvh; }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div><div class="loading-text" id="loading-text">加载中...</div></div>
  <div class="modal-overlay" id="modal-overlay"><div class="modal"><div class="modal-icon" id="modal-icon">⚠️</div><div class="modal-title" id="modal-title">确认操作</div><div class="modal-message" id="modal-message">确定要执行此操作吗？</div><div class="modal-buttons"><button class="modal-btn confirm" id="modal-confirm-btn" onclick="confirmModalAction()">确定</button><button class="modal-btn cancel" onclick="closeModal()">取消</button></div></div></div>
  
  <div class="modal-overlay" id="export-format-overlay">
    <div class="export-format-panel">
      <div class="export-format-title">📤 选择导出格式</div>
      <div class="export-format-options">
        <button class="export-format-btn" onclick="doExportFavorites('md')">
          <span class="format-icon">📝</span>
          <span class="format-info"><div class="format-name">Markdown (.md)</div><div class="format-desc">适合阅读和分享</div></span>
        </button>
        <button class="export-format-btn" onclick="doExportFavorites('txt')">
          <span class="format-icon">📄</span>
          <span class="format-info"><div class="format-name">纯文本 (.txt)</div><div class="format-desc">简洁纯文字格式</div></span>
        </button>
      </div>
      <div style="margin-top: 16px; text-align: center;"><button class="modal-btn cancel" onclick="closeExportFormatPanel()">取消</button></div>
    </div>
  </div>
  
  <div class="modal-overlay" id="conv-export-format-overlay">
    <div class="export-format-panel">
      <div class="export-format-title">📤 导出对话格式</div>
      <div class="export-format-options">
        <button class="export-format-btn" onclick="doExportConversations('json')">
          <span class="format-icon">📋</span>
          <span class="format-info"><div class="format-name">JSON (.json)</div><div class="format-desc">完整数据，可重新导入</div></span>
        </button>
        <button class="export-format-btn" onclick="doExportConversations('md')">
          <span class="format-icon">📝</span>
          <span class="format-info"><div class="format-name">Markdown (.md)</div><div class="format-desc">带格式排版，适合归档阅读</div></span>
        </button>
        <button class="export-format-btn" onclick="doExportConversations('txt')">
          <span class="format-icon">📄</span>
          <span class="format-info"><div class="format-name">纯文本 (.txt)</div><div class="format-desc">方便阅读和分享</div></span>
        </button>
      </div>
      <div style="margin-top: 16px; text-align: center;"><button class="modal-btn cancel" onclick="closeConvExportFormatPanel()">取消</button></div>
    </div>
  </div>
  
  <!-- 黑名单管理弹窗 -->
  <div class="modal-overlay" id="blacklist-overlay">
    <div class="blacklist-panel">
      <div class="blacklist-title">词云黑名单</div>
      <div class="blacklist-add">
        <input type="text" class="blacklist-input" id="blacklist-input" placeholder="输入要屏蔽的词...">
        <button class="blacklist-add-btn" onclick="addToBlacklist()">添加</button>
      </div>
      <div class="blacklist-list" id="blacklist-list"></div>
      <div style="margin-top: 16px; text-align: center;"><button class="modal-btn primary" onclick="closeBlacklistPanel()">完成</button></div>
    </div>
  </div>
  
  <div class="modal-overlay" id="settings-overlay"><div class="settings-panel"><div class="settings-title"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>设置</div>
  <div class="settings-section"><label class="settings-label">昵称设置</label><div class="settings-row"><div class="settings-field"><input type="text" class="settings-input" id="settings-user-name" placeholder="用户昵称"></div><div class="settings-field"><input type="text" class="settings-input" id="settings-ai-name" placeholder="助手昵称"></div></div></div>
  <div class="settings-section"><label class="settings-label">自定义头像</label><div class="avatar-upload-section"><div class="avatar-upload-item"><div class="avatar-upload-preview" id="user-avatar-preview" onclick="document.getElementById('user-avatar-input').click()">🧸<span class="avatar-delete" onclick="event.stopPropagation(); deleteAvatar('user')">×</span></div><span class="avatar-upload-label">用户</span><input type="file" id="user-avatar-input" class="avatar-upload-input" accept="image/*" onchange="handleAvatarUpload(event, 'user')"></div><div class="avatar-upload-item"><div class="avatar-upload-preview" id="ai-avatar-preview" onclick="document.getElementById('ai-avatar-input').click()">🤖<span class="avatar-delete" onclick="event.stopPropagation(); deleteAvatar('ai')">×</span></div><span class="avatar-upload-label">助手</span><input type="file" id="ai-avatar-input" class="avatar-upload-input" accept="image/*" onchange="handleAvatarUpload(event, 'ai')"></div></div></div>
  <div class="settings-section"><label class="settings-label">主题颜色</label><div class="theme-selector"><div class="theme-dot pink active" data-theme="pink" onclick="selectTheme('pink')" title="樱花粉"></div><div class="theme-dot brown" data-theme="brown" onclick="selectTheme('brown')" title="奶茶棕"></div><div class="theme-dot blue" data-theme="blue" onclick="selectTheme('blue')" title="雾霾蓝"></div><div class="theme-dot purple" data-theme="purple" onclick="selectTheme('purple')" title="香芋紫"></div><div class="theme-dot green" data-theme="green" onclick="selectTheme('green')" title="抹茶绿"></div><div class="theme-dot red" data-theme="red" onclick="selectTheme('red')" title="深红"></div><div class="theme-dot dark" data-theme="dark" onclick="selectTheme('dark')" title="夜间模式"></div></div></div>
  <div class="settings-section"><label class="settings-label">聊天背景</label><div class="pattern-selector"><div class="pattern-option none active" data-pattern="none" onclick="selectPattern('none')" title="无"><div class="pattern-preview"></div></div><div class="pattern-option grid" data-pattern="grid" onclick="selectPattern('grid')" title="格纹"><div class="pattern-preview"></div></div><div class="pattern-option dots" data-pattern="dots" onclick="selectPattern('dots')" title="波点"><div class="pattern-preview"></div></div><div class="pattern-option stripes" data-pattern="stripes" onclick="selectPattern('stripes')" title="条纹"><div class="pattern-preview"></div></div><div class="pattern-option custom" data-pattern="custom" onclick="handleCustomBgClick()" title="自定义"><div class="pattern-preview" id="custom-bg-preview"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div><span class="bg-delete" onclick="event.stopPropagation(); deleteCustomBg()">×</span></div><input type="file" id="bg-upload-input" class="avatar-upload-input" accept="image/*" onchange="handleBgUpload(event)"></div></div>
  <div class="settings-section"><label class="settings-label">聊天字体</label><select class="font-selector" id="settings-font" onchange="selectFont(this.value)"><option value="system">系统默认</option><option value="naikai">内海简体</option><option value="moonstars">月星楷</option><option value="jason">清松手写体</option><option value="pingfang">平方时光体</option><option value="cococheese">小可奶酪体</option><option value="zcool">站酷快乐体</option><option value="ZZJmarkpen">宅在家麦克笔</option><option value="ZLabsBitmap">ZLabsBitmap像素</option><option value="KURIYAMAKOUCHI">栗山巧緻フォント</option></select></div>
  <div class="settings-section"><label class="settings-label">字体大小</label><div class="fontsize-selector"><input type="range" class="fontsize-slider" id="fontsize-slider" min="12" max="18" value="14" oninput="selectFontSizeBySlider(this.value)"></div></div><div class="settings-buttons"><button class="modal-btn primary" onclick="saveSettings()">保存</button><button class="modal-btn cancel" onclick="closeSettings()">取消</button></div></div></div>
  <div class="toast" id="toast"></div>
  <header class="header"><div class="header-left"><button class="header-btn" onclick="toggleDrawer()"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><button class="header-btn" onclick="document.getElementById('file-input').click()"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></button></div><div class="header-logo" id="header-logo">GPT Chat Viewer</div><input type="file" id="file-input" accept=".json" multiple onchange="handleFileSelect(event)"></header>
  <div class="drawer-overlay" id="drawer-overlay" onclick="toggleDrawer()"></div>
  <nav class="drawer" id="drawer"><div class="drawer-header"><h2 id="drawer-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><span id="drawer-title-text">我们的回忆</span></h2><p id="drawer-subtitle">还没有上传对话哦~</p></div><div class="drawer-menu"><div class="drawer-menu-item active" data-view="conversations" onclick="switchView('conversations')"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><span class="label">对话</span></div><div class="drawer-menu-item" data-view="favorites" onclick="switchView('favorites')"><svg class="icon-svg" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span class="label">收藏</span></div><div class="drawer-menu-item" data-view="stats" onclick="switchView('stats')"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="label">统计</span></div><div class="drawer-menu-item" data-view="timeline" onclick="switchView('timeline')"><svg class="icon-svg" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="label">时间轴</span></div><div class="drawer-menu-item" onclick="openSettings()"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span class="label">设置</span></div><div class="drawer-menu-item danger" onclick="showClearDataModal()"><svg class="icon-svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span class="label">清除</span></div></div><div class="conv-actions" id="conv-actions"><button class="conv-action-btn" id="select-mode-btn" onclick="toggleSelectMode()">☑ 多选</button><button class="conv-action-btn" id="export-selected-btn" onclick="exportSelectedConversations()" style="display:none;">📤 导出</button><button class="conv-action-btn danger" id="delete-selected-btn" onclick="showDeleteSelectedModal()" style="display:none;">🗑 删除</button></div><div class="conv-search"><input type="text" id="conv-search-input" placeholder="🔍 搜索对话标题..." oninput="filterConversations()"></div><div class="drawer-conversations" id="drawer-conversations"><div class="empty-state"><div class="icon">📭</div><p>上传JSON后这里会显示对话列表~</p></div></div></nav>
  <main class="main-content">
    <div class="view-upload" id="view-upload"><div class="upload-box" id="upload-box"><div class="icon">📁</div><h2>上传你的对话记录</h2><p>拖拽 ChatGPT 导出的 JSON 文件到这里<br>或点击下方按钮选择文件</p><button class="upload-btn" onclick="document.getElementById('file-input').click()">✨ 选择文件</button><div class="upload-hint">💡 支持多次上传，会自动去重合并哦~<br>📝 改名的对话会自动识别并更新</div></div></div>
    <div class="view-chat" id="view-chat"><div class="chat-header" id="chat-header"><div class="chat-title-row"><div class="chat-title" id="chat-title">对话标题</div><button class="collapse-btn" id="collapse-btn" onclick="toggleHeaderCollapse()" title="折叠/展开">▲</button></div><div class="collapsible-section" id="collapsible-section"><div class="search-section"><div class="search-box"><input type="text" id="search-input" placeholder="搜索消息内容..." enterkeyhint="search"><button type="button" id="search-submit" class="search-submit-btn" title="搜索">🔍</button></div><div class="search-mode-toggle"><button class="search-mode-btn active" data-mode="current" onclick="setSearchMode('current')">当前对话</button><button class="search-mode-btn" data-mode="global" onclick="setSearchMode('global')">全部对话</button></div><div class="global-search-info" id="global-search-info"><span class="search-result-count" id="search-result-count">找到 0 条结果</span><div class="search-nav-btns"><button class="search-nav-btn" onclick="navigateSearchResult(-1)">◀ 上一个</button><button class="search-nav-btn" onclick="navigateSearchResult(1)">下一个 ▶</button></div></div></div></div></div><div class="timeline-nav" id="timeline-nav"></div><div class="chat-messages" id="chat-messages"></div></div>
    <div class="view-global-search" id="view-global-search"><div class="global-search-header"><div class="global-search-title"><button class="global-search-back" onclick="exitGlobalSearch()">←</button><h2>🔍 全局搜索结果</h2></div><div class="global-search-stats" id="global-search-stats">搜索中...</div></div><div class="global-search-results" id="global-search-results"><div class="empty-state"><div class="icon">🔍</div><p>输入关键词开始搜索~</p></div></div></div>
    <div class="view-conv-select" id="view-conv-select"><div class="day-header"><button class="day-back-btn" onclick="switchView('timeline')">←</button><div class="day-title"><h2 id="conv-select-title">2024年1月1日</h2><p id="conv-select-subtitle">请选择要查看的对话窗口</p></div></div><div class="conv-select-list" id="conv-select-list"></div></div>
    <div class="view-day-messages" id="view-day-messages"><div class="day-header"><button class="day-back-btn" onclick="backToConvSelect()">←</button><div class="day-title"><h2 id="day-messages-title">2024年1月1日</h2><p id="day-messages-subtitle">共 0 条消息</p></div></div><div class="day-messages" id="day-messages-container"></div></div>
    <div class="view-favorites" id="view-favorites"><div class="favorites-header"><h2 class="view-title"><svg class="title-icon-fill" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>收藏的消息</h2><div class="favorites-actions"><button class="fav-action-btn" id="fav-select-btn" onclick="toggleFavSelectMode()">☑ 多选</button><button class="fav-action-btn" id="fav-select-all-btn" onclick="selectAllFavorites()" style="display:none;">全选</button><button class="fav-action-btn danger" id="fav-unfav-all-btn" onclick="unfavoriteSelected()" style="display:none;">🗑 取消收藏</button><button class="fav-action-btn export" id="fav-export-btn" onclick="showExportFormatPanel()" style="display:none;">📤 导出选中</button></div></div><div class="favorites-list" id="favorites-list"><div class="empty-state"><div class="icon">⭐</div><p>还没有收藏任何消息~<br>在聊天中点击☆来收藏吧</p></div></div></div>
    <div class="view-stats" id="view-stats">
      <h2 class="view-title"><svg class="title-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>聊天统计</h2>
      <div class="stats-header">
        <div class="month-nav">
          <button onclick="changeMonth(-1)">◀</button>
          <span class="month-label" id="month-label">2024年1月</span>
          <button onclick="changeMonth(1)">▶</button>
        </div>
        <div class="chart-toggle">
          <button class="chart-toggle-btn active" id="heatmap-btn" onclick="setChartMode('heatmap')" title="热力图">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          </button>
          <button class="chart-toggle-btn" id="linechart-btn" onclick="setChartMode('linechart')" title="折线图">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </button>
          <button class="chart-toggle-btn" id="yearchart-btn" onclick="setChartMode('year')" title="年度统计">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="10" width="4" height="10"/><rect x="10" y="5" width="4" height="15"/><rect x="17" y="8" width="4" height="12"/></svg>
          </button>
        </div>
      </div>
      <div class="calendar" id="calendar-container">
        <div class="calendar-weekdays"><span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span></div>
        <div class="calendar-days" id="calendar-days"></div>
      </div>
      <div class="line-chart-container" id="line-chart-container">
        <canvas class="line-chart-canvas" id="line-chart-canvas"></canvas>
      </div>
      <div class="line-chart-container" id="year-chart-container">
        <canvas class="line-chart-canvas" id="year-chart-canvas"></canvas>
      </div>
      <div class="stats-summary">
        <div class="stat-card"><div class="stat-value" id="stat-total-words">0</div><div class="stat-label">本月总字数</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-total-days">0</div><div class="stat-label">聊天天数</div></div>
      </div>
      <!-- 聊天总览区域 -->
      <div class="chat-overview-section">
        <div class="overview-summary" id="overview-summary">
          <p class="overview-text" id="overview-text">加载中...</p>
          <!-- 总数据统计卡片 -->
          <div class="total-stats-section" id="total-stats-section">
            <div class="total-stats-card assistant">
              <div class="total-stats-header">
                <div class="total-stats-avatar" id="total-ai-avatar">🤖</div>
                <div class="total-stats-name" id="total-ai-name">助手</div>
              </div>
              <div class="total-stats-data">
                <div class="total-stats-row"><span class="label">总字数</span><span class="value" id="total-ai-words">0 字</span></div>
                <div class="total-stats-row"><span class="label">消息数</span><span class="value" id="total-ai-msgs">0 条</span></div>
                <div class="total-stats-row"><span class="label">平均每条</span><span class="value" id="total-ai-avg">0 字</span></div>
              </div>
            </div>
            <div class="total-stats-card user">
              <div class="total-stats-header">
                <div class="total-stats-avatar" id="total-user-avatar">🧸</div>
                <div class="total-stats-name" id="total-user-name">用户</div>
              </div>
              <div class="total-stats-data">
                <div class="total-stats-row"><span class="label">总字数</span><span class="value" id="total-user-words">0 字</span></div>
                <div class="total-stats-row"><span class="label">消息数</span><span class="value" id="total-user-msgs">0 条</span></div>
                <div class="total-stats-row"><span class="label">平均每条</span><span class="value" id="total-user-avg">0 字</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="overview-actions">
          <div class="random-moment-wrapper">
            <button class="overview-action-btn" onclick="randomJumpToMoment()">🎲 随机带我回某一刻</button>
            <span class="random-moment-hint">那一刻我们在想什么呢 ♡</span>
          </div>
        </div>
        <div class="overview-rankings">
          <div class="ranking-card">
            <div class="ranking-title">最用力的 Top 10 日</div>
            <div class="ranking-subtitle">这些是我们说得最多的日子</div>
            <div class="ranking-list" id="top-days-list"></div>
          </div>
          <div class="ranking-card">
            <div class="ranking-title">最长的 Top 10 对话</div>
            <div class="ranking-subtitle">这些是我们最舍不得停下来的对话</div>
            <div class="ranking-list" id="top-convs-list"></div>
          </div>
        </div>
      </div>
      <!-- 词云区域 -->
      <div class="wordcloud-section">
        <div class="wordcloud-header">
          <div class="wordcloud-title">
            <svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>
            高频词云
          </div>
          <div class="wordcloud-actions">
            <select class="wordcloud-filter" id="wordcloud-conv-filter" onchange="renderWordCloud()">
              <option value="all">全部窗口</option>
            </select>
            <select class="wordcloud-filter" id="wordcloud-date-filter" onchange="renderWordCloud()">
              <option value="all" selected>全部时间</option>
              <option value="month">当前月份</option>
            </select>
            <select class="wordcloud-filter" id="wordcloud-role-filter" onchange="renderWordCloud()">
              <option value="all" selected>全部角色</option>
              <option value="user">仅用户</option>
              <option value="assistant">仅助手</option>
            </select>
            <div class="wordcloud-block-row">
              <label class="wordcloud-checkbox-label">
                <input type="checkbox" id="wordcloud-hide-english" onchange="renderWordCloud()">
                <span class="custom-checkbox"></span>
                <span>屏蔽英文</span>
              </label>
              <button class="blacklist-btn" onclick="openBlacklistPanel()">黑名单</button>
            </div>
          </div>
        </div>
        <div class="wordcloud-container" id="wordcloud-container">
          <span class="wordcloud-empty">加载中...</span>
        </div>
      </div>
    </div>
    <div class="view-timeline" id="view-timeline"><h2 class="view-title"><svg class="title-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>按日期跳转</h2><div class="timeline-list" id="timeline-list"></div></div>
  </main>
  
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.3/dist/purify.min.js"></script>
<script>
    const DB_NAME = 'QithMiaoMiaoLogs';
    const DB_VERSION = 2;
    let db = null;
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains('conversations')) database.createObjectStore('conversations', { keyPath: 'id' });
          if (!database.objectStoreNames.contains('favorites')) database.createObjectStore('favorites', { keyPath: 'id' });
          if (!database.objectStoreNames.contains('metadata')) database.createObjectStore('metadata', { keyPath: 'key' });
        };
      });
    }
    async function saveConversationToDb(conv) { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readwrite'); const s = t.objectStore('conversations'); const r = s.put(conv); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function deleteConversationFromDb(convId) { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readwrite'); const s = t.objectStore('conversations'); const r = s.delete(convId); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function getAllConversationsFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['conversations'], 'readonly'); const s = t.objectStore('conversations'); const r = s.getAll(); r.onsuccess = () => resolve(r.result || []); r.onerror = () => reject(r.error); }); }
    async function saveFavoriteToDb(msgId, convId) { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readwrite'); const s = t.objectStore('favorites'); const r = s.put({ id: msgId, convId: convId }); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function removeFavoriteFromDb(msgId) { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readwrite'); const s = t.objectStore('favorites'); const r = s.delete(msgId); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error); }); }
    async function getAllFavoritesFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['favorites'], 'readonly'); const s = t.objectStore('favorites'); const r = s.getAll(); r.onsuccess = () => { const results = r.result || []; const favMap = new Map(); results.forEach(x => favMap.set(x.id, x.convId || null)); resolve(favMap); }; r.onerror = () => reject(r.error); }); }
    async function clearAllDataFromDb() { return new Promise((resolve, reject) => { const t = db.transaction(['conversations', 'favorites', 'metadata'], 'readwrite'); t.objectStore('conversations').clear(); t.objectStore('favorites').clear(); t.objectStore('metadata').clear(); t.oncomplete = () => resolve(); t.onerror = () => reject(t.error); }); }

    let allConversations = [], filteredConversations = [], conversationStats = {}, currentConvIndex = -1, currentConvId = null, currentMessages = [], allMessages = [], messagesByDate = {}, favorites = new Map(), statsByDate = {};
    let currentYear = new Date().getFullYear(), currentMonth = new Date().getMonth();
    let isSelectMode = false, selectedConvIds = new Set(), isFavSelectMode = false, selectedFavMsgIds = new Set(), modalConfirmCallback = null;
    const PAGE_SIZE = 2000;
    let paginationState = { messages: [], renderedCount: 0, highlightKw: null, showConvTitle: false, isPaginated: false };
    let searchMode = 'current', globalSearchResults = [], currentSearchResultIndex = -1, flatSearchResults = [], isHeaderCollapsed = false;
    let appSettings = { userName: '', aiName: '', theme: 'pink', fontSize: 14, pattern: 'none', userAvatar: '', aiAvatar: '', customBg: '', fontFamily: 'system' };
    let currentSearchKeyword = '';
    let isComposing = false;
    let chartMode = 'heatmap';
    let monthStatsCache = {}; // 月份统计缓存，key格式：YYYY-MM
    let wordcloudBlacklist = [];
    let wordDict = new Set(); // 分词词典
    let dictLoaded = false;
    
    // 加载分词词典
    async function loadWordDict() {
      try {
        // 尝试从相对路径加载词典
        const response = await fetch('dict/words.json');
        if (response.ok) {
          const data = await response.json();
          wordDict = new Set(data.words || []);
          dictLoaded = true;
          console.log(`词典加载成功，共 ${wordDict.size} 个词`);
        }
      } catch (e) {
        console.log('词典加载失败，使用简单分词模式', e);
        dictLoaded = false;
      }
    }

    // 停用词表
    const STOPWORDS = new Set([
      // 基础代词
      '我', '你', '他', '她', '它', '我们', '你们', '他们', '她们', '它们', '自己', '别人', '大家', '这', '那', '这个', '那个', '这些', '那些', '这里', '那里', '哪', '哪个', '哪些', '哪里', '谁', '什么', '怎么', '怎样', '如何', '多少', '几', '某', '每', '各',
      // 助词语气词
      '的', '地', '得', '了', '着', '过', '吗', '呢', '吧', '啊', '呀', '哇', '哦', '噢', '嗯', '唉', '哎', '啦', '喽', '嘛', '咯', '罢了', '而已', '而且', '并且',
      // 连词介词
      '和', '与', '及', '或', '或者', '但', '但是', '然而', '可是', '不过', '虽然', '虽', '尽管', '即使', '如果', '假如', '要是', '除非', '因为', '由于', '所以', '因此', '于是', '那么', '则', '就', '便', '才', '又', '也', '还', '再', '都', '只', '仅', '光', '单', '净', '全', '总', '老', '一直', '始终', '已经', '曾经', '正在', '将要', '快要', '刚刚', '刚', '立刻', '马上', '终于', '竟然', '居然', '简直', '几乎', '差点', '大概', '也许', '可能', '应该', '必须', '需要', '可以', '能够', '能', '会', '要', '想', '愿意', '肯', '敢', '在', '从', '到', '向', '往', '朝', '对', '跟', '同', '给', '为', '被', '把', '让', '叫', '使', '比', '按', '照', '根据', '关于', '至于', '对于', '除了', '除', '以', '用', '以便', '以免', '为了',
      // 程度副词
      '很', '太', '极', '非常', '十分', '特别', '相当', '比较', '更', '最', '越', '稍微', '略', '有点', '不', '没', '没有', '别', '甭', '勿', '未', '无', '非', '真', '真的', '确实', '实在', '其实', '事实上', '当然', '自然', '果然', '毕竟', '究竟', '到底', '反正', '反而', '倒', '偏偏', '恰恰', '恰好', '正好', '刚好',
      // 数量词
      '一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '百', '千', '万', '亿', '第', '个', '只', '条', '件', '本', '张', '把', '次', '遍', '回', '趟', '下', '番', '种', '样', '些', '点', '块',
      // 时间词
      '年', '月', '日', '号', '时', '分', '秒', '天', '周', '星期', '今天', '明天', '昨天', '现在', '刚才', '以前', '以后', '之前', '之后', '当时', '那时', '这时', '早', '晚', '上午', '下午', '中午', '晚上', '白天', '夜里', '时候', '的时候',
      // 方位词
      '上', '下', '左', '右', '前', '后', '里', '外', '内', '中', '旁', '边', '面', '头', '底', '东', '西', '南', '北', '里面', '外面', '上面', '下面', '前面', '后面', '旁边', '中间',
      // 语气词感叹词
      '哈哈', '哈哈哈', '哈哈哈哈', '嘿嘿', '呵呵', '嗯嗯', '好的', '好吧', '行', '额', '诶', '唔', '呃', '喔', '就是', '然后', '不是', '嘻嘻', '呜呜', '嗷', '噗', '啧', '嘶', '欸',
      // 基础动词
      '是', '有', '在', '说', '看', '想', '知道', '觉得', '认为', '感觉', '希望', '喜欢', '需要', '做', '去', '来', '走', '跑', '站', '坐', '起来', '出来', '进去', '回去', '过来', '过去', '下来', '上去', '进来', '出去',
      // 常见口语短语 - 代词+动词组合
      '你说', '我说', '他说', '她说', '你是', '我是', '他是', '她是', '是你', '是我', '是他', '是她', '你的', '我的', '他的', '她的',
      '你在', '我在', '你有', '我有', '你能', '我能', '你会', '我会', '你要', '我要', '你想', '我想', '你看', '我看',
      '你知道', '我知道', '你觉得', '我觉得', '你以为', '我以为', '你认为', '我认为', '你喜欢', '我喜欢',
      '你知道我', '我知道你', '你知道你', '我知道我', '你以为我', '我以为你', '你以为你', '我以为我',
      '你不是', '我不是', '他不是', '她不是', '不是你', '不是我', '不是他', '不是她',
      '你不是在', '我不是在', '你不是不', '我不是不', '你不是说', '我不是说',
      '你不要', '我不要', '你不能', '我不能', '你不会', '我不会', '你不想', '我不想',
      '你不需要', '我不需要', '你需要', '我需要',
      // 疑问/反问短语
      '是不是', '好不好', '行不行', '对不对', '要不要', '能不能', '会不会', '可不可以',
      '你是不是', '我是不是', '他是不是', '她是不是',
      '是因为', '不是因为', '是因为你', '是因为我', '不是因为你', '不是因为我',
      // 常见短语结构
      '的人', '的话', '的样子', '的感觉', '的意思', '的事', '的事情', '的问题', '的原因', '的结果',
      '一下', '一点', '一句', '一个', '一些', '一起', '一样', '一般', '一定', '一直',
      '那种', '这种', '什么样', '怎么样', '那样', '这样', '一样的',
      '比如', '比如说', '例如', '就像', '好像', '似乎', '仿佛',
      '而是', '还是', '就是', '只是', '不只是', '不仅是', '也是', '都是', '全是',
      '着你', '着我', '给你', '给我', '对你', '对我', '跟你', '跟我', '和你', '和我',
      '你一', '我一', '你这', '我这', '你那', '我那',
      '一句话', '你一句', '我一句', '每一下', '每一次', '每一个', '每一天',
      '来了', '去了', '走了', '回来', '回去', '过来', '过去', '起来', '下去',
      '地方', '时间', '东西', '事情', '问题', '情况', '方面', '方式', '方法',
      '怎么办', '怎么说', '怎么做', '怎么回事', '怎么了', '怎么会',
      '为什么', '是什么', '做什么', '说什么', '想什么', '干什么',
      '我就', '你就', '就我', '就你', '我就是', '你就是', '我就知道', '你就知道',
      '我现在', '你现在', '我现在就', '你现在就',
      '你是我', '我是你', '你是我的', '我是你的',
      '不行', '不好', '不对', '不能', '不会', '不想', '不要', '不用', '不必',
      '可以', '可能', '可是', '可以吗', '可以的', '可不可以',
      '好了', '行了', '算了', '得了', '够了', '完了', '好啦', '行啦',
      '那个', '这个', '哪个', '某个', '每个', '另一个', '下一个', '上一个',
      '另一', '其他', '别的', '其它', '另外',
      '只手', '只眼', '只脚', '另一只', '另一只手',
      '怀里', '手里', '心里', '眼里', '脑子里', '嘴里',
      '情绪', '感情', '心情', '状态',
      '小姐', '先生', '同学', '朋友', '老师',
      // 英文停用词
      'the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can', 'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'as', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why', 'how', 'all', 'each', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'just', 'and', 'but', 'if', 'or', 'because', 'until', 'while', 'although', 'though', 'this', 'that', 'these', 'those', 'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours', 'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'what', 'which', 'who', 'whom', 'am', 'about', 'like', 'just', 'know', 'think', 'want', 'see', 'come', 'go', 'get', 'make', 'say', 'tell', 'ask', 'use', 'find', 'give', 'take', 'need', 'feel', 'try', 'let', 'put', 'mean', 'keep', 'begin', 'seem', 'help', 'show', 'hear', 'play', 'run', 'move', 'live', 'believe', 'hold', 'bring', 'happen', 'write', 'provide', 'sit', 'stand', 'lose', 'pay', 'meet', 'include', 'continue', 'set', 'learn', 'change', 'lead', 'understand', 'watch', 'follow', 'stop', 'create', 'speak', 'read', 'allow', 'add', 'spend', 'grow', 'open', 'walk', 'win', 'offer', 'remember', 'love', 'consider', 'appear', 'buy', 'wait', 'serve', 'die', 'send', 'expect', 'build', 'stay', 'fall', 'cut', 'reach', 'kill', 'remain', 'yeah', 'yes', 'okay', 'ok', 'oh', 'um', 'uh', 'well', 'like', 'really', 'actually', 'basically', 'literally', 'honestly', 'seriously'
    ]);

    document.addEventListener('DOMContentLoaded', async () => {
      showLoading('正在初始化...');
      try { loadSettings(); loadBlacklist(); applySettings(); await loadWordDict(); await openDatabase(); await loadFromDatabase(); setupDragDrop(); setupSearchInput(); } catch (e) { console.error('初始化失败', e); showToast('初始化失败，请刷新重试'); }
      hideLoading();
    });

    // 黑名单管理
    function loadBlacklist() { try { const saved = localStorage.getItem('wordcloudBlacklist'); if (saved) wordcloudBlacklist = JSON.parse(saved); } catch (e) { console.error('加载黑名单失败', e); } }
    function saveBlacklist() { try { localStorage.setItem('wordcloudBlacklist', JSON.stringify(wordcloudBlacklist)); } catch (e) { console.error('保存黑名单失败', e); } }
    function openBlacklistPanel() { renderBlacklistList(); document.getElementById('blacklist-overlay').classList.add('show'); }
    function closeBlacklistPanel() { document.getElementById('blacklist-overlay').classList.remove('show'); renderWordCloud(); }
    function addToBlacklist(word) {
      const input = document.getElementById('blacklist-input');
      const wordToAdd = word || (input ? input.value.trim() : '');
      if (!wordToAdd) return;
      if (!wordcloudBlacklist.includes(wordToAdd)) {
        wordcloudBlacklist.push(wordToAdd);
        saveBlacklist();
        renderBlacklistList();
        if (input && !word) input.value = '';
        showToast(`已将"${wordToAdd}"加入黑名单`);
      }
    }
    function removeFromBlacklist(word) { wordcloudBlacklist = wordcloudBlacklist.filter(w => w !== word); saveBlacklist(); renderBlacklistList(); }
    
    // 词云二次确认删除
    function toggleWordDeleteBtn(element) {
      // 先移除其他词的删除按钮
      document.querySelectorAll('.wordcloud-word.show-delete').forEach(el => {
        if (el !== element) el.classList.remove('show-delete');
      });
      // 切换当前词的删除按钮显示状态
      element.classList.toggle('show-delete');
    }
    function confirmAddToBlacklist(word, element) {
      if (!wordcloudBlacklist.includes(word)) {
        wordcloudBlacklist.push(word);
        saveBlacklist();
        showToast(`已将"${word}"加入黑名单`);
      }
      // 直接从界面移除该词条
      if (element) {
        element.remove();
      }
    }
    
    function renderBlacklistList() {
      const container = document.getElementById('blacklist-list');
      if (!container) return;
      if (wordcloudBlacklist.length === 0) { container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);font-size:var(--font-size-small);">黑名单为空<br>点击词云中的词，再点×可添加</div>'; return; }
      container.innerHTML = wordcloudBlacklist.map(word => `<div class="blacklist-item"><span class="blacklist-item-word">${escapeHtml(word)}</span><button class="blacklist-item-delete" onclick="removeFromBlacklist('${escapeJsString(word)}')">×</button></div>`).join('');
    }

    function setupSearchInput() {
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-submit');
      if (!searchInput) return;
      // 不在每次输入时自动跳转；改为：按 Enter 或点 🔍 才执行搜索
      searchInput.addEventListener('compositionstart', () => { isComposing = true; });
      searchInput.addEventListener('compositionend', () => { isComposing = false; });
      // 允许“清空关键词”时自动回到正常视图，但不在输入过程中自动跳转
      searchInput.addEventListener('input', () => {
        if (isComposing) return;
        if (searchInput.value.trim() === '') handleSearch();
      });
      searchInput.addEventListener('keydown', (e) => {
        if (isComposing) return;
        if (e.key === 'Enter') { e.preventDefault(); handleSearch(); }
      });
      if (searchBtn) {
        searchBtn.addEventListener('click', () => { if (isComposing) return; handleSearch(); });
      }
    }

    function loadSettings() { try { const saved = localStorage.getItem('chatLogViewerSettings'); if (saved) appSettings = { ...appSettings, ...JSON.parse(saved) }; } catch (e) { console.error('加载设置失败', e); } }
    function saveSettingsToStorage() { try { localStorage.setItem('chatLogViewerSettings', JSON.stringify(appSettings)); } catch (e) { console.error('保存设置失败', e); } }
    function saveLastViewedConv(convId) { try { localStorage.setItem('lastViewedConvId', convId); } catch (e) { console.error('保存上次对话失败', e); } }
    function getLastViewedConv() { try { return localStorage.getItem('lastViewedConvId'); } catch (e) { return null; } }
    
    function applySettings() {
      if (appSettings.theme === 'pink') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', appSettings.theme);
      // 处理字体大小（支持旧的 small/medium/large 格式和新的数字格式）
      if (typeof appSettings.fontSize === 'string') {
        const sizeMap = { 'small': 12, 'medium': 14, 'large': 18 };
        appSettings.fontSize = sizeMap[appSettings.fontSize] || 14;
      }
      document.documentElement.style.setProperty('--font-size-base', appSettings.fontSize / 16 + 'rem');
      document.documentElement.style.setProperty('--font-size-small', (appSettings.fontSize - 2) / 16 + 'rem');
      document.documentElement.style.setProperty('--font-size-xs', (appSettings.fontSize - 3) / 16 + 'rem');
      applyPattern();
      applyFont();
      updateHeaderLogo(); updatePageTitle();
      // 更新总统计卡片的名字和头像
      if (typeof renderTotalStats === 'function') renderTotalStats();
    }
    
    function applyFont() {
      const fontMap = {
        'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif',
        'naikai': '"NaikaiFont", -apple-system, BlinkMacSystemFont, sans-serif',
        'moonstars': '"MoonStarsKai", -apple-system, BlinkMacSystemFont, sans-serif',
        'jason': '"JasonHandwriting", -apple-system, BlinkMacSystemFont, sans-serif',
        'pingfang': '"PingfangShiguang", -apple-system, BlinkMacSystemFont, sans-serif',
        'cococheese': '"cococheese", -apple-system, BlinkMacSystemFont, sans-serif',
        'zcool': '"ZCOOL KuaiLe", -apple-system, BlinkMacSystemFont, sans-serif',
        'ZLabsBitmap': '"ZLabsBitmap", -apple-system, BlinkMacSystemFont, sans-serif',
        'ZZJmarkpen': '"ZZJmarkpen", -apple-system, BlinkMacSystemFont, sans-serif',
        'KURIYAMAKOUCHI': '"KURIYAMAKOUCHI", -apple-system, BlinkMacSystemFont, sans-serif'
      };
      const fontFamily = fontMap[appSettings.fontFamily] || fontMap['system'];
      document.documentElement.style.setProperty('--chat-font', fontFamily);
      document.querySelectorAll('.message-bubble').forEach(el => { el.style.fontFamily = fontFamily; });
    }
    
    function applyPattern() {
      const chatMessages = document.getElementById('chat-messages');
      const dayMessages = document.getElementById('day-messages-container');
      [chatMessages, dayMessages].forEach(container => {
        if (!container) return;
        if (appSettings.pattern === 'none') {
          container.removeAttribute('data-pattern');
          container.style.backgroundImage = '';
        } else if (appSettings.pattern === 'custom' && appSettings.customBg) {
          container.setAttribute('data-pattern', 'custom');
          container.style.backgroundImage = `url(${appSettings.customBg})`;
        } else {
          container.setAttribute('data-pattern', appSettings.pattern);
          container.style.backgroundImage = '';
        }
      });
    }
    
    function handleBgUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { showToast('请选择图片文件'); return; }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxSize = 1920;
          let width = img.width, height = img.height;
          if (width > maxSize || height > maxSize) {
            if (width > height) { height *= maxSize / width; width = maxSize; }
            else { width *= maxSize / height; height = maxSize; }
          }
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const base64 = canvas.toDataURL('image/jpeg', 0.85);
          
          appSettings.customBg = base64;
          appSettings.pattern = 'custom';
          updateCustomBgPreview();
          document.querySelectorAll('.pattern-option').forEach(p => p.classList.toggle('active', p.dataset.pattern === 'custom'));
          applyPattern();
          showToast('背景已设置');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }
    
    function updateCustomBgPreview() {
      const preview = document.getElementById('custom-bg-preview');
      const option = preview?.parentElement;
      if (!preview || !option) return;
      if (appSettings.customBg) {
        preview.style.backgroundImage = `url(${appSettings.customBg})`;
        option.classList.add('has-image');
      } else {
        preview.style.backgroundImage = '';
        option.classList.remove('has-image');
      }
    }
    
    function selectPattern(pattern) {
      document.querySelectorAll('.pattern-option').forEach(p => p.classList.toggle('active', p.dataset.pattern === pattern));
      appSettings.pattern = pattern;
      applyPattern();
    }
    
    function handleCustomBgClick() {
      if (appSettings.customBg) {
        selectPattern('custom');
      } else {
        document.getElementById('bg-upload-input').click();
      }
    }
    
    function deleteCustomBg() {
      appSettings.customBg = '';
      if (appSettings.pattern === 'custom') {
        appSettings.pattern = 'none';
        document.querySelectorAll('.pattern-option').forEach(p => p.classList.toggle('active', p.dataset.pattern === 'none'));
      }
      updateCustomBgPreview();
      applyPattern();
    }
    
    function hasChinese(str) { return /[\u4e00-\u9fa5]/.test(str); }
    
    function updateHeaderLogo() {
      const logo = document.getElementById('header-logo'), dt = document.getElementById('drawer-title-text');
      const un = appSettings.userName, an = appSettings.aiName;
      
      if (un && an) {
        const hasChineseChar = hasChinese(un) || hasChinese(an);
        if (hasChineseChar) {
          logo.innerHTML = `${escapeHtml(an)}&${escapeHtml(un)} Logs`;
          logo.classList.remove('font-decorative');
          dt.innerHTML = `${escapeHtml(an)}&${escapeHtml(un)}`;
          dt.classList.remove('font-decorative');
        } else {
          logo.innerHTML = `<span class="font-decorative">${escapeHtml(an)}&${escapeHtml(un)} Logs</span>`;
          dt.innerHTML = `<span class="font-decorative">${escapeHtml(an)}&${escapeHtml(un)}</span>`;
        }
      } else if (un) {
        const hasChineseChar = hasChinese(un);
        if (hasChineseChar) {
          logo.innerHTML = `${escapeHtml(un)}的聊天记录`;
          logo.classList.remove('font-decorative');
          dt.innerHTML = `${escapeHtml(un)}的回忆`;
        } else {
          logo.innerHTML = `<span class="font-decorative">${escapeHtml(un)}'s Logs</span>`;
          dt.innerHTML = `<span class="font-decorative">${escapeHtml(un)}'s Memories</span>`;
        }
      } else if (an) {
        const hasChineseChar = hasChinese(an);
        if (hasChineseChar) {
          logo.innerHTML = `${escapeHtml(an)} 聊天记录`;
          logo.classList.remove('font-decorative');
          dt.innerHTML = `与${escapeHtml(an)}的回忆`;
        } else {
          logo.innerHTML = `<span class="font-decorative">${escapeHtml(an)} Logs</span>`;
          dt.innerHTML = `<span class="font-decorative">${escapeHtml(an)} Memories</span>`;
        }
      } else {
        logo.innerHTML = `<span class="font-decorative">GPT Chat Viewer</span>`;
        dt.textContent = '我们的回忆';
        dt.classList.remove('font-decorative');
      }
    }
    
    function updatePageTitle() { document.title = (appSettings.userName && appSettings.aiName) ? `${appSettings.aiName} & ${appSettings.userName}` : 'ChatGPT 对话查看器'; }
    function openSettings() {
      document.getElementById('settings-user-name').value = appSettings.userName;
      document.getElementById('settings-ai-name').value = appSettings.aiName;
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === appSettings.theme));
      document.querySelectorAll('.pattern-option').forEach(p => p.classList.toggle('active', p.dataset.pattern === appSettings.pattern));
      document.getElementById('settings-font').value = appSettings.fontFamily || 'system';
      document.getElementById('fontsize-slider').value = appSettings.fontSize || 14;
      updateAvatarPreview('user', appSettings.userAvatar);
      updateAvatarPreview('ai', appSettings.aiAvatar);
      updateCustomBgPreview();
      document.getElementById('settings-overlay').classList.add('show'); toggleDrawer(false);
    }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('show'); }
    function selectTheme(theme) { document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === theme)); appSettings.theme = theme; if (theme === 'pink') document.body.removeAttribute('data-theme'); else document.body.setAttribute('data-theme', theme); applyPattern(); if (chartMode === 'linechart') renderLineChart(); }
    function selectFontSizeBySlider(size) {
      // 只更新设置值，不立即应用，等保存时才应用
      appSettings.fontSize = parseInt(size);
    }
    function selectFont(font) { appSettings.fontFamily = font; applyFont(); }
    function saveSettings() { appSettings.userName = document.getElementById('settings-user-name').value.trim(); appSettings.aiName = document.getElementById('settings-ai-name').value.trim(); saveSettingsToStorage(); applySettings(); if (currentMessages.length > 0) renderMessages(currentMessages); closeSettings(); showToast('设置已保存'); }
    
    // 时间戳校验函数，过滤异常数据（如57370年这种）
    function isValidTimestamp(ts) {
      if (!ts || ts <= 0) return false;
      const date = new Date(ts * 1000);
      const year = date.getFullYear();
      return year >= 2020 && year <= 2030;
    }
    async function loadFromDatabase() { 
      try { 
        allConversations = await getAllConversationsFromDb(); 
        filteredConversations = [...allConversations]; 
        if (allConversations.length > 0) { 
          processAllConversations(); 
          document.getElementById('view-upload').style.display = 'none'; 
          const lastConvId = getLastViewedConv();
          const lastConv = lastConvId ? allConversations.find(c => c.id === lastConvId) : null;
          if (lastConv) { openConversation(lastConvId); } 
          else if (filteredConversations.length > 0) { openConversation(filteredConversations[0].id); }
        } 
        favorites = await getAllFavoritesFromDb(); 
      } catch (e) { console.error('加载数据失败', e); } 
    }
    
    function toggleHeaderCollapse() { isHeaderCollapsed = !isHeaderCollapsed; const s = document.getElementById('collapsible-section'), b = document.getElementById('collapse-btn'), t = document.getElementById('timeline-nav'); if (isHeaderCollapsed) { s.classList.add('collapsed'); b.classList.add('collapsed'); t.classList.add('collapsed'); } else { s.classList.remove('collapsed'); b.classList.remove('collapsed'); t.classList.remove('collapsed'); } }
    
    function setSearchMode(mode) {
      searchMode = mode;
      document.querySelectorAll('.search-mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
      document.getElementById('search-input').placeholder = mode === 'global' ? '全局搜索消息内容...' : '搜索当前对话...';
      const keyword = document.getElementById('search-input').value.trim();
      if (keyword) { handleSearch(); } else { document.getElementById('global-search-info').classList.remove('show'); if (mode === 'current' && currentMessages.length > 0) { renderMessages(currentMessages); } }
    }
    
    function handleSearch() {
      const keyword = document.getElementById('search-input').value.toLowerCase().trim();
      currentSearchKeyword = keyword;
      if (!keyword) { document.getElementById('global-search-info').classList.remove('show'); if (searchMode === 'current') renderMessages(currentMessages); else { document.getElementById('view-global-search').classList.remove('show'); document.getElementById('view-chat').classList.add('show'); } return; }
      if (searchMode === 'current') performCurrentSearch(keyword); else performGlobalSearch(keyword);
    }
    
    function performCurrentSearch(keyword) {
      const filtered = currentMessages.filter(m => m.content.toLowerCase().includes(keyword));
      flatSearchResults = filtered.map(m => ({ convId: currentConvId, msgId: m.id }));
      currentSearchResultIndex = flatSearchResults.length > 0 ? 0 : -1;
      if (filtered.length > 0) { document.getElementById('search-result-count').textContent = `找到 ${filtered.length} 条结果`; document.getElementById('global-search-info').classList.add('show'); } else { document.getElementById('global-search-info').classList.remove('show'); }
      renderMessages(filtered, null, false, keyword);
      if (currentSearchResultIndex >= 0) highlightCurrentSearchResult();
    }
    
    function performGlobalSearch(keyword) {
      globalSearchResults = []; flatSearchResults = [];
      allConversations.forEach(conv => {
        const messages = parseMessages(conv.mapping, conv.current_node);
        const matches = [];
        messages.forEach(msg => {
          if (msg.content.toLowerCase().includes(keyword)) {
            const preview = generatePreview(msg.content, keyword);
            matches.push({ msgId: msg.id, content: msg.content, preview: preview, time: msg.time, role: msg.role });
            flatSearchResults.push({ convId: conv.id, convTitle: conv.title || '未命名对话', msgId: msg.id });
          }
        });
        if (matches.length > 0) globalSearchResults.push({ convId: conv.id, convTitle: conv.title || '未命名对话', matchCount: matches.length, matches: matches });
      });
      currentSearchResultIndex = flatSearchResults.length > 0 ? 0 : -1;
      const totalMatches = flatSearchResults.length, convCount = globalSearchResults.length;
      document.getElementById('search-result-count').textContent = `找到 ${totalMatches} 条结果，分布在 ${convCount} 个对话中`;
      document.getElementById('global-search-info').classList.add('show');
      renderGlobalSearchResults(keyword);
      document.getElementById('view-chat').classList.remove('show');
      document.getElementById('view-global-search').classList.add('show');
      document.getElementById('global-search-stats').textContent = `共 ${totalMatches} 条匹配，来自 ${convCount} 个对话`;
    }
    
    function generatePreview(content, keyword) { const lc = content.toLowerCase(), idx = lc.indexOf(keyword.toLowerCase()); if (idx === -1) return content.substring(0, 100); const start = Math.max(0, idx - 30), end = Math.min(content.length, idx + keyword.length + 50); let p = ''; if (start > 0) p += '...'; p += content.substring(start, end); if (end < content.length) p += '...'; return p; }
    
    function renderGlobalSearchResults(keyword) {
      const container = document.getElementById('global-search-results');
      if (globalSearchResults.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">🔍</div><p>没有找到匹配的消息~</p></div>'; return; }
      container.innerHTML = globalSearchResults.map(r => {
        const fm = r.matches[0], hp = highlightKeywordInText(escapeHtml(fm.preview), keyword);
        return `<div class="search-result-item" onclick="jumpToSearchResult('${r.convId}', '${fm.msgId}', '${escapeJsString(keyword)}')"><div class="search-result-conv-title">📚 ${escapeHtml(r.convTitle)}<span class="search-result-count-badge">${r.matchCount} 处匹配</span></div><div class="search-result-preview">${hp}</div><div class="search-result-meta">${fm.role === 'user' ? '🧸 用户' : '🤖 AI'} · ${fm.time ? formatFullDateTime(fm.time) : ''}</div></div>`;
      }).join('');
    }
    
    function escapeJsString(s) { return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"'); }
    function highlightKeywordInText(text, keyword) { if (!keyword) return text; const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi'); return text.replace(regex, '<span class="highlight">$1</span>'); }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    
    
    // Markdown renderer (safe)
    const _md = (window.markdownit ? window.markdownit({ html: false, linkify: true, breaks: true }) : null);
    function renderMarkdown(src) {
      const s = (src == null) ? '' : String(src);
      if (!_md) {
        // fallback: escaped + preserve line breaks
        return escapeHtml(s).replace(/\n/g, '<br>');
      }
      const dirty = _md.render(s);
      if (window.DOMPurify) return DOMPurify.sanitize(dirty);
      return dirty;
    }

    // Highlight keyword inside rendered HTML without breaking tags
    function highlightKeywordInHtml(html, keyword) {
      if (!keyword) return html;
      const kw = String(keyword).trim();
      if (!kw) return html;

      const container = document.createElement('div');
      container.innerHTML = html;

      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null);
      const regex = new RegExp(escapeRegExp(kw), 'gi');
      const targets = [];
      let node;
      while ((node = walker.nextNode())) {
        if (!node.nodeValue) continue;
        regex.lastIndex = 0;
        if (regex.test(node.nodeValue)) targets.push(node);
      }

      targets.forEach(n => {
        const text = n.nodeValue;
        const frag = document.createDocumentFragment();
        let last = 0, m;
        regex.lastIndex = 0;
        while ((m = regex.exec(text))) {
          if (m.index > last) frag.appendChild(document.createTextNode(text.slice(last, m.index)));
          const mark = document.createElement('mark');
          mark.className = 'kw-highlight';
          mark.textContent = m[0];
          frag.appendChild(mark);
          last = m.index + m[0].length;
        }
        if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
        n.parentNode.replaceChild(frag, n);
      });

      return container.innerHTML;
    }

    function jumpToSearchResult(convId, msgId, keyword) {
      currentSearchKeyword = keyword;
      openConversation(convId, keyword, true);
      document.getElementById('view-global-search').classList.remove('show'); 
      document.getElementById('view-chat').classList.add('show');
      setTimeout(() => scrollToMessage(msgId), 300);
    }
    
    function navigateSearchResult(dir) {
      if (flatSearchResults.length === 0) return;
      currentSearchResultIndex += dir;
      if (currentSearchResultIndex < 0) currentSearchResultIndex = flatSearchResults.length - 1;
      else if (currentSearchResultIndex >= flatSearchResults.length) currentSearchResultIndex = 0;
      const r = flatSearchResults[currentSearchResultIndex];
      if (searchMode === 'current') highlightCurrentSearchResult(); else jumpToSearchResult(r.convId, r.msgId, document.getElementById('search-input').value);
    }
    
    function highlightCurrentSearchResult() {
      document.querySelectorAll('.message.highlight').forEach(el => el.classList.remove('highlight'));
      if (currentSearchResultIndex < 0 || currentSearchResultIndex >= flatSearchResults.length) return;
      const r = flatSearchResults[currentSearchResultIndex];
      document.getElementById('search-result-count').textContent = `${currentSearchResultIndex + 1} / ${flatSearchResults.length}`;
      scrollToMessage(r.msgId);
    }
    
    function exitGlobalSearch() { document.getElementById('view-global-search').classList.remove('show'); document.getElementById('view-chat').classList.add('show'); document.getElementById('global-search-info').classList.remove('show'); setSearchMode('current'); }
    
    function setupDragDrop() { const ub = document.getElementById('upload-box'); if (!ub) return; ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => ub.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); })); ub.addEventListener('dragover', () => ub.classList.add('dragover')); ub.addEventListener('dragleave', () => ub.classList.remove('dragover')); ub.addEventListener('drop', e => { ub.classList.remove('dragover'); const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.json')); if (files.length > 0) processFiles(files); }); }
    function handleFileSelect(e) { const files = Array.from(e.target.files); if (files.length > 0) processFiles(files); e.target.value = ''; }
    async function processFiles(files) {
      showLoading('正在解析文件...');
      let totalAdded = 0, totalUpdated = 0;
      try {
        for (const file of files) { const r = await processFile(file); totalAdded += r.added; totalUpdated += r.updated; }
        filteredConversations = [...allConversations]; processAllConversations(); document.getElementById('view-upload').style.display = 'none';
        if (filteredConversations.length > 0 && !currentConvId) openConversation(filteredConversations[0].id);
        if (totalAdded > 0 && totalUpdated > 0) showToast(`新增 ${totalAdded} 个对话，更新 ${totalUpdated} 个对话`);
        else if (totalAdded > 0) showToast(`成功导入 ${totalAdded} 个新对话`);
        else if (totalUpdated > 0) showToast(`更新了 ${totalUpdated} 个对话`);
        else showToast('没有新内容需要导入');
      } catch (err) { console.error('解析失败', err); showToast('文件解析失败，请确认是有效的JSON文件'); }
      hideLoading();
    }
   // 🟢 芥末泥特制：万能格式适配器 1.
// 🟢 芥末泥特制：万能格式适配器 (支援 RikkaHub 数据库导出)
    async function processFile(file) {
      const text = await readFileAsText(file);
      let data = JSON.parse(text);
      let newConvs = [];

      // 1. RikkaHub 标题文件 (ConversationEntity)
      if (Array.isArray(data) && data.length > 0 && data[0].assistant_id !== undefined && data[0].title !== undefined) {
          window.rikkaHubTitles = window.rikkaHubTitles || {};
          let updated = 0;
          data.forEach(c => {
              window.rikkaHubTitles[c.id] = c.title; // 记住标题
              const existIdx = allConversations.findIndex(ex => ex.id === c.id);
              if(existIdx >= 0) {
                  allConversations[existIdx].title = c.title;
                  saveConversationToDb(allConversations[existIdx]);
                  updated++;
              }
          });
          if (updated > 0) renderConversationList();
          showToast('📚 识别到标题库，已缓存！请接着上传 message_node.json 哦~');
          return { added: 1, updated: updated }; // ✨ 欺骗系统，不让它报“没有新内容”
      }
      
      // 2. RikkaHub 消息文件 (message_node)
      else if (Array.isArray(data) && data.length > 0 && data[0].conversation_id !== undefined && data[0].messages !== undefined) {
          showToast('💬 识别到 RikkaHub 聊天记录，正在疯狂解包...');
          newConvs = transformRikkaHubMessagesToConvs(data, file.name);
      }
      
      // 3. API 手账本数据
      else if (data.platforms || data.apiKeys) {
          showToast('✨ 侦测到 API 手账本数据...');
          newConvs = [transformApiDataToConv(data, file.name)];
      } 
      // 4. RikkaHub 软件设置
      else if (data.assistants || data.providers) {
          showToast('⚙️ 侦测到 RikkaHub 设定档...');
          newConvs = [transformRikkaHubSettingsToConv(data, file.name)];
      }
      // 5. 简单的列表格式
      else if (Array.isArray(data) && data.length > 0 && data[0].role && data[0].content) {
          showToast('📝 侦测到自定义聊天列表...');
          newConvs = [transformSimpleListToConv(data, file.name)];
      }
      // 6. 默认：ChatGPT 原生格式
      else {
          newConvs = Array.isArray(data) ? data : [data];
      }

      // 统一处理 ID 和保存逻辑
      newConvs = newConvs.map(c => { 
          const pid = c.conversation_id || c.id || ('conv_' + Date.now()); 
          c.id = pid; 
          c.conversation_id = pid; 
          return c; 
      });
      
      let addedCount = 0, updatedCount = 0;
      for (const conv of newConvs) {
        const existIdx = allConversations.findIndex(c => c.conversation_id === conv.conversation_id || c.id === conv.id);
        if (existIdx >= 0) { 
            const ex = allConversations[existIdx]; 
            if ((conv.update_time || conv.create_time || 0) >= (ex.update_time || ex.create_time || 0)) { 
                if (conv.title && conv.title.includes("未命名") && ex.title && !ex.title.includes("未命名")) {
                    conv.title = ex.title;
                }
                allConversations[existIdx] = conv; 
                await saveConversationToDb(conv); 
                updatedCount++; 
            } 
        } else { 
            allConversations.push(conv); 
            await saveConversationToDb(conv); 
            addedCount++; 
        }
      }
      return { added: addedCount, updated: updatedCount };
    }
    // 到这

    // 🌸 芥末泥特制：解包 RikkaHub 数据库消息 (金刚不坏修复版)
    function transformRikkaHubMessagesToConvs(nodes, fileName) {
        const convGroups = {};
        nodes.forEach(node => {
            const cid = node.conversation_id;
            if(!convGroups[cid]) convGroups[cid] = [];
            convGroups[cid].push(node);
        });

        const newConvs = [];
        for (const cid in convGroups) {
            const group = convGroups[cid];
            group.sort((a, b) => (a.node_index || 0) - (b.node_index || 0));
            
            const mapping = {};
            let lastId = null;
            let createTime = Math.floor(Date.now() / 1000);
            
            group.forEach(node => {
                try {
                    let msgsRaw = node.messages;
                    if (!msgsRaw) return;
                    
                    // ✨ 暴力剥开两层套娃
                    let parsed = msgsRaw;
                    if (typeof parsed === 'string') {
                        parsed = JSON.parse(parsed);
                        if (typeof parsed === 'string') parsed = JSON.parse(parsed);
                    }
                    
                    let msgData = null;
                    if (Array.isArray(parsed)) {
                        const idx = node.select_index || 0;
                        msgData = parsed[idx] || parsed[0];
                    } else if (typeof parsed === 'object') {
                        msgData = parsed;
                    }
                    
                    if (msgData) {
                        const msgId = msgData.id || node.id || ("msg_" + Math.random().toString(36).substr(2, 9));
                        
                        let msgTime = msgData.createAt || msgData.create_at || node.create_at || Date.now();
                        if (msgTime > 10000000000) msgTime = Math.floor(msgTime / 1000); 
                        if (lastId === null) createTime = msgTime;

                        // 2. 💡 提取纯文本内容
                        let contentStr = "";
                        
                        // ✨ 芥末泥的新魔法：专门对付 parts 盒子
                        if (msgData.parts && Array.isArray(msgData.parts)) {
                            contentStr = msgData.parts.map(p => p.text || '').join('');
                        } 
                        // 后面的备用方案保留
                        else if (msgData.content) {
                            if (typeof msgData.content === 'string') contentStr = msgData.content;
                            else if (Array.isArray(msgData.content)) contentStr = msgData.content.map(c => c.text || (typeof c === 'string' ? c : JSON.stringify(c))).join('');
                            else if (msgData.content.text) contentStr = msgData.content.text;
                            else contentStr = JSON.stringify(msgData.content);
                        } else if (msgData.text) {
                            contentStr = msgData.text;
                        } else {
                            contentStr = "【解析提示：没找到文本字段，原始数据如下】\n" + JSON.stringify(msgData, null, 2);
                        }
                        let role = (msgData.role || "user").toLowerCase();
                        if (role === "model" || role === "ai" || role === "system" || role === "assistant") {
                            role = "assistant";
                        } else {
                            role = "user";
                        }

                        mapping[msgId] = {
                            message: {
                                id: msgId,
                                author: { role: role },
                                content: { content_type: "text", parts: [contentStr] },
                                create_time: msgTime,
                                metadata: { model_slug: msgData.model || null }
                            },
                            parent: lastId
                        };
                        lastId = msgId;
                    }
                } catch(e) {
                    console.error("解包消息失败", e, node);
                }
            });

            let title = "📖 未命名对话";
            if (window.rikkaHubTitles && window.rikkaHubTitles[cid]) {
                title = window.rikkaHubTitles[cid];
            }

            newConvs.push({
                id: cid,
                conversation_id: cid,
                title: title,
                mapping: mapping,
                current_node: lastId,
                create_time: createTime
            });
        }
        return newConvs;
    }
    // 到这

    function readFileAsText(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.onerror = () => reject(reader.error); reader.readAsText(file); }); }
    function processAllConversations() {
      allMessages = []; statsByDate = {}; messagesByDate = {}; conversationStats = {};
      allConversations.sort((a, b) => (a.create_time || 0) - (b.create_time || 0));
      filteredConversations = [...allConversations];
      allConversations.forEach((conv, convIndex) => {
        const messages = parseMessages(conv.mapping, conv.current_node);
        let totalChars = 0; messages.forEach(m => totalChars += m.content.length);
        conversationStats[conv.id] = { messageCount: messages.length, totalChars, estimatedTokens: Math.round(totalChars / 2.5) };
        messages.forEach(msg => {
          msg.convIndex = convIndex; msg.convId = conv.id; msg.convTitle = conv.title || `对话 ${convIndex + 1}`;
          allMessages.push(msg);
          if (msg.time && isValidTimestamp(msg.time)) {
            const ds = formatDateKey(msg.time);
            if (!messagesByDate[ds]) messagesByDate[ds] = [];
            messagesByDate[ds].push(msg);
            if (!statsByDate[ds]) statsByDate[ds] = { userWords: 0, aiWords: 0, count: 0 };
            const words = msg.content.length;
            if (msg.role === 'user') statsByDate[ds].userWords += words; else statsByDate[ds].aiWords += words;
            statsByDate[ds].count++;
          }
        });
      });
      // 预计算所有月份的热力图数据缓存
      monthStatsCache = {};
      Object.keys(statsByDate).forEach(ds => {
        const [year, month] = ds.split('-');
        const monthKey = `${year}-${month}`;
        if (!monthStatsCache[monthKey]) monthStatsCache[monthKey] = { totalWords: 0, activeDays: 0, days: {} };
        const st = statsByDate[ds];
        const dayWords = st.userWords + st.aiWords;
        monthStatsCache[monthKey].totalWords += dayWords;
        monthStatsCache[monthKey].activeDays++;
        monthStatsCache[monthKey].days[ds] = dayWords;
      });
      renderConversationList(); updateDrawerSubtitle(); renderCalendar(); renderTimeline(); updateConvFilterOptions();
    }
    function parseMessages(mapping, currentNode) {
      if (!mapping) return [];
      const messages = [], seenIds = new Set();
      for (const [nodeId, nodeData] of Object.entries(mapping)) {
        if (!nodeData || !nodeData.message) continue;
        if (seenIds.has(nodeId)) continue;
        const msg = nodeData.message, role = msg.author?.role, contentType = msg.content?.content_type;
        if (contentType === 'user_editable_context') {
          const aboutUser = msg.metadata?.user_context_message_data?.about_user_message || '', aboutModel = msg.metadata?.user_context_message_data?.about_model_message || '';
          let dc = ''; if (aboutUser) dc += `【关于用户】\n${aboutUser.trim()}\n\n`; if (aboutModel) dc += `【自定义指令】\n${aboutModel.trim()}`;
          if (dc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'system', type: 'custom_instructions', content: dc.trim(), time: msg.create_time || 0, model: null }); }
          continue;
        }
        if (msg.author?.role === 'tool' && msg.author?.name === 'bio') { const bc = msg.content?.parts?.join('') || ''; if (bc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'memory', type: 'memory_update', content: bc.trim(), time: msg.create_time || 0, model: null }); } continue; }
        if (role === 'assistant' && msg.recipient === 'bio') { const bc = msg.content?.parts?.join('') || ''; if (bc.trim()) { seenIds.add(nodeId); messages.push({ id: nodeId, role: 'memory', type: 'memory_call', content: `💾 写入记忆库:\n${bc.trim()}`, time: msg.create_time || 0, model: msg.metadata?.model_slug || null }); } continue; }
        if (msg.metadata?.is_visually_hidden_from_conversation) continue;
        const content = msg.content?.parts?.join('') || '';
        if (!content.trim()) continue;
        if (role === 'user' || role === 'assistant') {
          if (msg.recipient && msg.recipient !== 'all') continue;
          let model = null; if (role === 'assistant') model = msg.metadata?.model_slug || msg.metadata?.default_model_slug || msg.author?.metadata?.model_slug || null;
          seenIds.add(nodeId); messages.push({ id: nodeId, role, type: 'normal', content, time: msg.create_time || 0, model });
        }
      }
      messages.sort((a, b) => (a.time || 0) - (b.time || 0));
      const deduped = []; for (const m of messages) { if (!deduped.some(x => x.time === m.time && x.content === m.content && x.role === m.role)) deduped.push(m); }
      return deduped;
    }
    function renderConversationList() {
      const container = document.getElementById('drawer-conversations');
      if (filteredConversations.length === 0) { container.innerHTML = allConversations.length === 0 ? '<div class="empty-state"><div class="icon">📭</div><p>上传JSON后这里会显示对话列表~</p></div>' : '<div class="empty-state"><div class="icon">🔍</div><p>没有找到匹配的对话</p></div>'; return; }
      container.innerHTML = filteredConversations.map(conv => {
        const isActive = currentConvId === conv.id, isSelected = selectedConvIds.has(conv.id), stats = conversationStats[conv.id] || { messageCount: 0, estimatedTokens: 0 }, escapedTitle = escapeHtml(conv.title || '未命名对话');
        let timeRange = ''; if (conv.create_time) { const cd = formatDateCompact(conv.create_time); if (conv.update_time && conv.update_time !== conv.create_time) { const ud = formatDateCompact(conv.update_time); timeRange = cd !== ud ? `${cd} ~ ${ud}` : cd; } else timeRange = cd; }
        return `<div class="conv-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}" data-conv-id="${conv.id}"><div class="conv-checkbox ${isSelectMode ? 'show' : ''} ${isSelected ? 'checked' : ''}" onclick="event.stopPropagation(); toggleConvSelection('${conv.id}')">${isSelected ? '✓' : ''}</div><div class="conv-info"><div class="conv-title">💬 ${escapedTitle}</div><div class="conv-meta">${timeRange}<br>${stats.messageCount} 条消息 · ${formatNumber(stats.estimatedTokens)} tokens</div></div><button class="conv-delete-btn" onclick="event.stopPropagation(); showDeleteConvModal('${conv.id}', '${escapedTitle.replace(/'/g, "\\'")}')">×</button></div>`;
      }).join('');
      container.querySelectorAll('.conv-item').forEach(item => { item.addEventListener('click', function() { const convId = this.dataset.convId; if (isSelectMode) toggleConvSelection(convId); else openConversation(convId); }); });
    }
    function toggleSelectMode() { isSelectMode = !isSelectMode; selectedConvIds.clear(); const btn = document.getElementById('select-mode-btn'), eb = document.getElementById('export-selected-btn'), db = document.getElementById('delete-selected-btn'); if (isSelectMode) { btn.classList.add('active'); btn.innerHTML = '✓ 取消'; eb.style.display = 'flex'; db.style.display = 'flex'; } else { btn.classList.remove('active'); btn.innerHTML = '☑ 多选'; eb.style.display = 'none'; db.style.display = 'none'; } renderConversationList(); }
    function toggleConvSelection(convId) { if (selectedConvIds.has(convId)) selectedConvIds.delete(convId); else selectedConvIds.add(convId); renderConversationList(); }
    function exportSelectedConversations() { if (selectedConvIds.size === 0) { showToast('请先选择要导出的对话'); return; } document.getElementById('conv-export-format-overlay').classList.add('show'); }
    function closeConvExportFormatPanel() { document.getElementById('conv-export-format-overlay').classList.remove('show'); }
    function doExportConversations(format) {
      closeConvExportFormatPanel();
      const sc = allConversations.filter(c => selectedConvIds.has(c.id));
      const timestamp = formatDateForFile(new Date());
      const userName = appSettings.userName || '用户';
      const aiName = appSettings.aiName || 'AI';
      
      if (format === 'json') {
        const ds = JSON.stringify(sc, null, 2);
        downloadFile(ds, `conversations_${sc.length}_${timestamp}.json`, 'application/json');
      } else if (format === 'md') {
        let et = `# 对话导出\n\n> 导出时间: ${new Date().toLocaleString('zh-CN')}  \n> 共 ${sc.length} 个对话\n\n---\n\n`;
        sc.forEach(conv => {
          const messages = parseMessages(conv.mapping, conv.current_node);
          et += `## 📚 ${conv.title || '未命名对话'}\n\n`;
          messages.forEach(msg => {
            if (msg.type === 'custom_instructions' || msg.type === 'memory_update' || msg.type === 'memory_call') return;
            const role = msg.role === 'user' ? `🦜 ${userName}` : `🤖 ${aiName}`;
            const time = msg.time ? formatFullDateTime(msg.time) : '';
            et += `### ${role} ${time}\n\n${msg.content}\n\n---\n\n`;
          });
        });
        downloadFile(et, `conversations_${sc.length}_${timestamp}.md`, 'text/markdown;charset=utf-8');
      } else if (format === 'txt') {
        let et = `对话导出\n导出时间: ${new Date().toLocaleString('zh-CN')}\n共 ${sc.length} 个对话\n${'='.repeat(50)}\n`;
        sc.forEach(conv => {
          const messages = parseMessages(conv.mapping, conv.current_node);
          et += `\n\n${'═'.repeat(50)}\n📚 ${conv.title || '未命名对话'}\n${'─'.repeat(50)}\n`;
          messages.forEach(msg => {
            if (msg.type === 'custom_instructions' || msg.type === 'memory_update' || msg.type === 'memory_call') return;
            const role = msg.role === 'user' ? `👤 ${userName}` : `🤖 ${aiName}`;
            const time = msg.time ? formatFullDateTime(msg.time) : '';
            et += `\n[${role}] ${time}\n${msg.content}\n`;
          });
        });
        downloadFile(et, `conversations_${sc.length}_${timestamp}.txt`, 'text/plain;charset=utf-8');
      }
      
      showToast(`已导出 ${sc.length} 个对话`);
      toggleSelectMode();
    }
    function showDeleteConvModal(convId, convTitle) { showModal('🗑️', '删除对话', `确定要删除「${convTitle}」吗？\n此操作无法撤销！`, async () => { await performDeleteConversation(convId); }, true); }
    function showDeleteSelectedModal() { if (selectedConvIds.size === 0) { showToast('请先选择要删除的对话'); return; } showModal('🗑️', '批量删除', `确定要删除选中的 ${selectedConvIds.size} 个对话吗？\n此操作无法撤销！`, async () => { showLoading('正在删除...'); try { const ids = [...selectedConvIds]; for (const id of ids) { await deleteConversationFromDb(id); allConversations = allConversations.filter(c => c.id !== id); } selectedConvIds.clear(); toggleSelectMode(); processAllConversations(); if (allConversations.length === 0) { document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); currentConvId = null; } else if (ids.includes(currentConvId)) openConversation(allConversations[0].id); showToast('已删除选中的对话'); } catch (e) { console.error('删除失败', e); showToast('删除失败，请重试'); } hideLoading(); }, true); }
    async function performDeleteConversation(convId) { showLoading('正在删除...'); try { await deleteConversationFromDb(convId); allConversations = allConversations.filter(c => c.id !== convId); processAllConversations(); if (allConversations.length === 0) { document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); currentConvId = null; } else if (currentConvId === convId) openConversation(allConversations[0].id); showToast('已删除对话'); } catch (e) { console.error('删除失败', e); showToast('删除失败，请重试'); } hideLoading(); }
    function filterConversations() { const kw = document.getElementById('conv-search-input').value.toLowerCase().trim(); filteredConversations = !kw ? [...allConversations] : allConversations.filter(c => (c.title || '').toLowerCase().includes(kw)); renderConversationList(); }
    
    function openConversation(convId, highlightKeyword = null, skipScrollReset = false) { 
      const conv = allConversations.find(c => c.id === convId); 
      if (!conv) return; 
      currentConvId = convId; 
      currentConvIndex = allConversations.indexOf(conv); 
      currentMessages = parseMessages(conv.mapping, conv.current_node); 
      document.getElementById('chat-title').textContent = conv.title || '未命名对话'; 
      saveLastViewedConv(convId);
      const kwToHighlight = highlightKeyword || null;
      renderMessages(currentMessages, null, false, kwToHighlight); 
      renderChatTimeline(); 
      renderConversationList(); 
      document.getElementById('view-upload').style.display = 'none'; 
      document.getElementById('view-chat').classList.add('show'); 
      document.getElementById('view-favorites').classList.remove('show'); 
      document.getElementById('view-stats').classList.remove('show'); 
      document.getElementById('view-timeline').classList.remove('show'); 
      document.getElementById('view-day-messages').classList.remove('show'); 
      document.getElementById('view-global-search').classList.remove('show');
      document.getElementById('view-conv-select').classList.remove('show');
      document.querySelectorAll('.drawer-menu-item').forEach(el => el.classList.toggle('active', el.dataset.view === 'conversations')); 
      toggleDrawer(false);
      if (!skipScrollReset) { document.getElementById('chat-messages').scrollTop = 0; }
      applyPattern();
    }
    
    function renderMessageBatch(messages, showConvTitle, highlightKw, lastDate = '', lastConvId = '') {
      let html = '';
      const userName = appSettings.userName || '', aiName = appSettings.aiName || '';
      messages.forEach(msg => {
        const ds = msg.time ? formatDateKey(msg.time) : '';
        if (showConvTitle && msg.convId !== lastConvId) { html += `<div class="conv-group-title">📚 ${escapeHtml(msg.convTitle)}</div>`; lastConvId = msg.convId; }
        if (ds && ds !== lastDate) { html += `<div class="date-divider" id="date-${ds}"><span>${formatDate(msg.time)}</span></div>`; lastDate = ds; }
        let dc = renderMarkdown(msg.content); if (highlightKw) dc = highlightKeywordInHtml(dc, highlightKw);
        if (msg.type === 'custom_instructions') { html += `<div class="message system" id="msg-${msg.id}" data-date="${ds}"><div class="message-avatar-wrapper"><div class="message-avatar">⚙️</div></div><div class="message-body"><div class="message-bubble"><span class="system-label">📋 窗口自定义指令</span><div style="white-space: pre-wrap;">${dc}</div></div></div></div>`; }
        else if (msg.type === 'memory_update' || msg.type === 'memory_call') { html += `<div class="message memory" id="msg-${msg.id}" data-date="${ds}"><div class="message-avatar-wrapper"><div class="message-avatar">🧠</div></div><div class="message-body"><div class="message-bubble"><span class="memory-label">💾 记忆库操作</span><div style="white-space: pre-wrap;">${dc}</div></div><div class="message-footer"><span class="message-time">${msg.time ? formatFullDateTime(msg.time) : ''}</span></div></div></div>`; }
        else {
          const isFav = favorites.has(msg.id), mb = msg.model ? `<span class="message-model">${formatModelName(msg.model)}</span>` : '', an = msg.role === 'user' ? userName : aiName;
          const convIdForFav = msg.convId || currentConvId;
          const avatarContent = msg.role === 'user'
            ? (appSettings.userAvatar ? `<img src="${appSettings.userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🧸')
            : (appSettings.aiAvatar ? `<img src="${appSettings.aiAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🤖');
          const copyIcon = `<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
          html += `<div class="message ${msg.role}" id="msg-${msg.id}" data-date="${ds}" data-content="${escapeHtml(msg.content).replace(/"/g, '&quot;')}"><div class="message-avatar-wrapper"><div class="message-avatar">${avatarContent}</div>${an ? `<span class="avatar-name">${escapeHtml(an)}</span>` : ''}</div><div class="message-body"><button class="msg-delete-x" onclick="event.stopPropagation(); showDeleteMsgModal('${msg.id}', '${convIdForFav}')" title="删除此消息">×</button><div class="message-bubble">${dc}</div><div class="message-footer"><span class="message-time">${msg.time ? formatFullDateTime(msg.time) : ''}</span>${mb}<button class="star-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${msg.id}', '${convIdForFav}', this)">${isFav ? '⭐' : '☆'}</button><button class="msg-copy-btn" onclick="copyMessageToClipboard(this)" title="复制消息">${copyIcon}</button></div></div></div>`;
        }
      });
      return { html, lastDate, lastConvId };
    }

    function renderMessages(messages, container = null, showConvTitle = false, highlightKw = null, forceCount = 0) {
      const tc = container || document.getElementById('chat-messages');
      if (messages.length === 0) { tc.innerHTML = '<div class="empty-state"><div class="icon">💬</div><p>没有消息~</p></div>'; paginationState.isPaginated = false; return; }
      const isMainContainer = !container;
      const initialCount = forceCount > 0 ? Math.min(forceCount, messages.length) : (isMainContainer && messages.length > PAGE_SIZE ? PAGE_SIZE : messages.length);
      const isPaginated = isMainContainer && initialCount < messages.length;
      if (isMainContainer) {
        paginationState = { messages, renderedCount: initialCount, highlightKw, showConvTitle, isPaginated };
      }
      const toRender = messages.slice(0, initialCount);
      const { html } = renderMessageBatch(toRender, showConvTitle, highlightKw);
      let fullHtml = html;
      if (isPaginated) {
        const remaining = messages.length - initialCount;
        fullHtml += `<div class="load-more-container" id="load-more-container"><button class="load-more-btn" onclick="loadMoreMessages()">加载更多消息（剩余 ${remaining} 条）</button></div>`;
      }
      tc.innerHTML = fullHtml;
      addCodeCopyButtons(tc);
      addMessageClickHandlers(tc);
      applyFont();
    }

    function loadMoreMessages() {
      if (!paginationState.isPaginated) return;
      const { messages, renderedCount, highlightKw, showConvTitle } = paginationState;
      const nextBatch = messages.slice(renderedCount, renderedCount + PAGE_SIZE);
      const prevMsg = messages[renderedCount - 1];
      const lastDate = prevMsg?.time ? formatDateKey(prevMsg.time) : '';
      const lastConvId = prevMsg?.convId || '';
      const { html } = renderMessageBatch(nextBatch, showConvTitle, highlightKw, lastDate, lastConvId);
      const loadMoreEl = document.getElementById('load-more-container');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      addCodeCopyButtons(tempDiv);
      tempDiv.querySelectorAll('.message.user, .message.assistant').forEach(msg => {
        msg.addEventListener('click', (e) => {
          if (e.target.closest('button') || e.target.closest('a')) return;
          const wasShowing = msg.classList.contains('show-delete');
          document.querySelectorAll('.message.show-delete').forEach(m => m.classList.remove('show-delete'));
          if (!wasShowing) msg.classList.add('show-delete');
        });
      });
      while (tempDiv.firstChild) { loadMoreEl.parentNode.insertBefore(tempDiv.firstChild, loadMoreEl); }
      paginationState.renderedCount += nextBatch.length;
      const remaining = messages.length - paginationState.renderedCount;
      if (remaining > 0) {
        loadMoreEl.querySelector('.load-more-btn').textContent = `加载更多消息（剩余 ${remaining} 条）`;
      } else {
        loadMoreEl.remove();
        paginationState.isPaginated = false;
      }
      applyFont();
    }

    function renderMessagesUpTo(targetIndex, callback) {
      const neededCount = targetIndex + 50;
      if (neededCount <= paginationState.renderedCount) { if (callback) callback(); return; }
      showToast('⏳ 加载中...');
      setTimeout(() => {
        const { messages, highlightKw, showConvTitle } = paginationState;
        const count = Math.min(neededCount, messages.length);
        const toRender = messages.slice(0, count);
        const { html } = renderMessageBatch(toRender, showConvTitle, highlightKw);
        const tc = document.getElementById('chat-messages');
        const remaining = messages.length - count;
        let fullHtml = html;
        if (remaining > 0) {
          fullHtml += `<div class="load-more-container" id="load-more-container"><button class="load-more-btn" onclick="loadMoreMessages()">加载更多消息（剩余 ${remaining} 条）</button></div>`;
          paginationState.renderedCount = count;
          paginationState.isPaginated = true;
        } else {
          paginationState.renderedCount = messages.length;
          paginationState.isPaginated = false;
        }
        tc.innerHTML = fullHtml;
        addCodeCopyButtons(tc);
        addMessageClickHandlers(tc);
        applyFont();
        if (callback) callback();
      }, 10);
    }

    function scrollToMessage(msgId, highlight = true) {
      let el = document.getElementById(`msg-${msgId}`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        if (highlight) { el.classList.add('highlight'); setTimeout(() => el.classList.remove('highlight'), 3000); }
        return;
      }
      if (paginationState.isPaginated) {
        const targetIdx = paginationState.messages.findIndex(m => m.id === msgId);
        if (targetIdx >= 0) {
          renderMessagesUpTo(targetIdx, () => {
            const el2 = document.getElementById(`msg-${msgId}`);
            if (el2) {
              el2.scrollIntoView({ behavior: 'smooth', block: 'center' });
              if (highlight) { el2.classList.add('highlight'); setTimeout(() => el2.classList.remove('highlight'), 3000); }
            }
          });
        }
      }
    }
    function formatModelName(m) { const mm = { 'gpt-4': 'GPT-4', 'gpt-4o': 'GPT-4o', 'gpt-4o-mini': 'GPT-4o mini', 'gpt-4-turbo': 'GPT-4 Turbo', 'gpt-3.5-turbo': 'GPT-3.5', 'text-davinci-002-render-sha': 'GPT-3.5', 'gpt-4-gizmo': 'GPT-4 (GPTs)', 'o1-preview': 'o1-preview', 'o1-mini': 'o1-mini' }; return mm[m] || m; }

    // 代码块复制按钮功能
    function addCodeCopyButtons(container) {
      const copyIcon = `<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
      const checkIcon = `<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
      container.querySelectorAll('.message-bubble pre').forEach(pre => {
        if (pre.parentElement.classList.contains('code-block-wrapper')) return;
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        const btn = document.createElement('button');
        btn.className = 'code-copy-btn';
        btn.innerHTML = copyIcon;
        btn.title = '复制代码';
        btn.onclick = async (e) => {
          e.stopPropagation();
          const code = pre.querySelector('code');
          const text = code ? code.textContent : pre.textContent;
          try {
            await navigator.clipboard.writeText(text);
            btn.innerHTML = checkIcon;
            btn.classList.add('copied');
            setTimeout(() => {
              btn.innerHTML = copyIcon;
              btn.classList.remove('copied');
            }, 1500);
          } catch (err) {
            showToast('复制失败');
          }
        };
        wrapper.appendChild(btn);
      });
    }

    // 消息复制功能
    function copyMessageToClipboard(btn) {
      const msg = btn.closest('.message');
      const content = msg?.dataset?.content;
      if (!content) { showToast('复制失败'); return; }
      const copyIcon = `<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
      const checkIcon = `<svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
      navigator.clipboard.writeText(content).then(() => {
        btn.innerHTML = checkIcon;
        btn.classList.add('copied');
        setTimeout(() => {
          btn.innerHTML = copyIcon;
          btn.classList.remove('copied');
        }, 1500);
      }).catch(() => showToast('复制失败'));
    }

    // 消息点击事件，用于显示删除按钮
    let messageClickHandlerInitialized = false;
    function addMessageClickHandlers(container) {
      container.querySelectorAll('.message.user, .message.assistant').forEach(msg => {
        msg.addEventListener('click', (e) => {
          // 如果点击的是按钮或链接，不处理
          if (e.target.closest('button') || e.target.closest('a')) return;
          // 切换当前消息的显示状态
          const wasShowing = msg.classList.contains('show-delete');
          // 先移除所有消息的show-delete
          document.querySelectorAll('.message.show-delete').forEach(m => m.classList.remove('show-delete'));
          // 如果之前没显示，则显示
          if (!wasShowing) msg.classList.add('show-delete');
        });
      });
      // 点击其他区域时隐藏删除按钮（只添加一次）
      if (!messageClickHandlerInitialized) {
        messageClickHandlerInitialized = true;
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.message')) {
            document.querySelectorAll('.message.show-delete').forEach(m => m.classList.remove('show-delete'));
          }
        });
      }
    }

    function renderChatTimeline() { const nav = document.getElementById('timeline-nav'), dates = [...new Set(currentMessages.filter(m => m.time).map(m => formatDateKey(m.time)))]; if (dates.length <= 1) { nav.classList.remove('show'); return; } nav.innerHTML = dates.map(d => `<button class="timeline-btn" onclick="scrollToDate('${d}')">${formatDateShort(d)}</button>`).join(''); nav.classList.add('show'); }
    function scrollToDate(ds) {
      let d = document.getElementById(`date-${ds}`);
      if (d) { d.scrollIntoView({ behavior: 'smooth', block: 'start' }); return; }
      if (paginationState.isPaginated) {
        const targetIdx = paginationState.messages.findIndex(m => m.time && formatDateKey(m.time) === ds);
        if (targetIdx >= 0) {
          renderMessagesUpTo(targetIdx, () => {
            const d2 = document.getElementById(`date-${ds}`);
            if (d2) d2.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        }
      }
    }
    
    async function toggleFavorite(msgId, convId, btn) { 
      if (favorites.has(msgId)) { 
        favorites.delete(msgId); 
        await removeFavoriteFromDb(msgId); 
        btn.classList.remove('active'); 
        btn.textContent = '☆'; 
      } else { 
        favorites.set(msgId, convId); 
        await saveFavoriteToDb(msgId, convId); 
        btn.classList.add('active'); 
        btn.textContent = '⭐'; 
      } 
    }
    
    // 删除单条消息
    function showDeleteMsgModal(msgId, convId) {
      showModal('🗑️', '删除消息', '确定要删除这条消息吗？\n此操作无法撤销！', async () => {
        await performDeleteMessage(msgId, convId);
      }, true);
    }
    
    async function performDeleteMessage(msgId, convId) {
      try {
        // 从当前对话中找到并删除消息
        const conv = allConversations.find(c => c.id === convId);
        if (conv && conv.mapping && conv.mapping[msgId]) {
          delete conv.mapping[msgId];
          // 保存更新后的对话到数据库
          await saveConversationToDb(conv);
        }
        // 从allMessages中移除
        const msgIndex = allMessages.findIndex(m => m.id === msgId);
        if (msgIndex >= 0) {
          const msg = allMessages[msgIndex];
          // 更新统计数据
          if (msg.time && isValidTimestamp(msg.time)) {
            const ds = formatDateKey(msg.time);
            if (statsByDate[ds]) {
              const words = msg.content.length;
              if (msg.role === 'user') statsByDate[ds].userWords -= words;
              else statsByDate[ds].aiWords -= words;
              statsByDate[ds].count--;
              if (statsByDate[ds].count <= 0) delete statsByDate[ds];
            }
            if (messagesByDate[ds]) {
              messagesByDate[ds] = messagesByDate[ds].filter(m => m.id !== msgId);
              if (messagesByDate[ds].length === 0) delete messagesByDate[ds];
            }
          }
          // 更新对话统计
          if (conversationStats[convId]) {
            conversationStats[convId].messageCount--;
            conversationStats[convId].totalChars -= msg.content.length;
            conversationStats[convId].estimatedTokens = Math.round(conversationStats[convId].totalChars / 2.5);
          }
          allMessages.splice(msgIndex, 1);
        }
        // 从currentMessages中移除并重新渲染
        const preserveCount = paginationState.isPaginated ? paginationState.renderedCount : 0;
        currentMessages = currentMessages.filter(m => m.id !== msgId);
        // 如果有收藏也移除
        if (favorites.has(msgId)) {
          favorites.delete(msgId);
          await removeFavoriteFromDb(msgId);
        }
        // 重新渲染（保持当前已加载数量）
        renderMessages(currentMessages, null, false, null, preserveCount);
        renderConversationList();
        showToast('已删除消息');
      } catch (e) {
        console.error('删除消息失败', e);
        showToast('删除失败，请重试');
      }
    }
    
    function toggleFavSelectMode() { isFavSelectMode = !isFavSelectMode; selectedFavMsgIds.clear(); const btn = document.getElementById('fav-select-btn'), sab = document.getElementById('fav-select-all-btn'), ub = document.getElementById('fav-unfav-all-btn'), eb = document.getElementById('fav-export-btn'); if (isFavSelectMode) { btn.classList.add('active'); btn.innerHTML = '✓ 取消'; sab.style.display = 'inline-flex'; ub.style.display = 'inline-flex'; eb.style.display = 'inline-flex'; } else { btn.classList.remove('active'); btn.innerHTML = '☑ 多选'; sab.style.display = 'none'; ub.style.display = 'none'; eb.style.display = 'none'; } renderFavorites(); }
    function toggleFavMsgSelection(msgId) { if (selectedFavMsgIds.has(msgId)) selectedFavMsgIds.delete(msgId); else selectedFavMsgIds.add(msgId); renderFavorites(); }
    function selectAllFavorites() { const fm = allMessages.filter(m => favorites.has(m.id)); if (selectedFavMsgIds.size === fm.length) selectedFavMsgIds.clear(); else fm.forEach(m => selectedFavMsgIds.add(m.id)); renderFavorites(); }
    async function unfavoriteSelected() { if (selectedFavMsgIds.size === 0) { showToast('请先选择要取消收藏的消息'); return; } showModal('🗑️', '取消收藏', `确定要取消收藏选中的 ${selectedFavMsgIds.size} 条消息吗？`, async () => { showLoading('正在取消收藏...'); try { for (const id of selectedFavMsgIds) { favorites.delete(id); await removeFavoriteFromDb(id); } const cnt = selectedFavMsgIds.size; selectedFavMsgIds.clear(); renderFavorites(); showToast(`已取消收藏 ${cnt} 条消息`); } catch (e) { console.error('取消收藏失败', e); showToast('操作失败，请重试'); } hideLoading(); }, true); }
    
    function showExportFormatPanel() {
      if (selectedFavMsgIds.size === 0) { showToast('请先选择要导出的消息'); return; }
      document.getElementById('export-format-overlay').classList.add('show');
    }
    function closeExportFormatPanel() { document.getElementById('export-format-overlay').classList.remove('show'); }
    
    function handleAvatarUpload(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { showToast('请选择图片文件'); return; }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxSize = 128;
          let width = img.width, height = img.height;
          if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
          else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          const base64 = canvas.toDataURL('image/jpeg', 0.8);
          
          if (type === 'user') { appSettings.userAvatar = base64; }
          else { appSettings.aiAvatar = base64; }
          updateAvatarPreview(type, base64);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }
    
    function deleteAvatar(type) {
      if (type === 'user') { appSettings.userAvatar = ''; updateAvatarPreview('user', ''); }
      else { appSettings.aiAvatar = ''; updateAvatarPreview('ai', ''); }
    }
    
    function updateAvatarPreview(type, base64) {
      const preview = document.getElementById(type === 'user' ? 'user-avatar-preview' : 'ai-avatar-preview');
      const defaultEmoji = type === 'user' ? '🧸' : '🤖';
      if (base64) {
        preview.innerHTML = `<img src="${base64}" alt="avatar"><span class="avatar-delete" onclick="event.stopPropagation(); deleteAvatar('${type}')">×</span>`;
      } else {
        preview.innerHTML = `${defaultEmoji}<span class="avatar-delete" onclick="event.stopPropagation(); deleteAvatar('${type}')">×</span>`;
      }
    }
    
    function doExportFavorites(format) {
      closeExportFormatPanel();
      const sm = allMessages.filter(m => selectedFavMsgIds.has(m.id));
      const timestamp = formatDateForFile(new Date());
      const userName = appSettings.userName || '我';
      const aiName = appSettings.aiName || 'AI';
      
      if (format === 'md') {
        let et = `# 收藏的消息导出\n导出时间: ${new Date().toLocaleString('zh-CN')}\n共 ${sm.length} 条消息\n\n---\n\n`; 
        let lct = ''; 
        sm.forEach(m => { 
          if (m.convTitle !== lct) { et += `## 📚 ${m.convTitle}\n\n`; lct = m.convTitle; } 
          const r = m.role === 'user' ? `🦜 ${userName}` : `🤖 ${aiName}`, t = m.time ? formatFullDateTime(m.time) : ''; 
          et += `### ${r} ${t}\n\n${m.content}\n\n---\n\n`; 
        }); 
        downloadFile(et, `favorites_${sm.length}_${timestamp}.md`, 'text/markdown;charset=utf-8');
      } 
      else if (format === 'txt') {
        let et = `收藏消息导出\n导出时间: ${new Date().toLocaleString('zh-CN')}\n共 ${sm.length} 条消息\n${'='.repeat(50)}\n\n`;
        let lct = '';
        sm.forEach(m => {
          if (m.convTitle !== lct) { et += `\n[${m.convTitle}]\n${'─'.repeat(30)}\n`; lct = m.convTitle; }
          const r = m.role === 'user' ? userName : aiName, t = m.time ? formatFullDateTime(m.time) : '';
          et += `\n[${r}] ${t}\n${m.content}\n`;
        });
        downloadFile(et, `favorites_${sm.length}_${timestamp}.txt`, 'text/plain;charset=utf-8');
      }
      
      showToast(`已导出 ${sm.length} 条收藏消息`); 
      toggleFavSelectMode();
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function renderFavorites() { 
      const c = document.getElementById('favorites-list'); 
      if (favorites.size === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">⭐</div><p>还没有收藏任何消息~<br>在聊天中点击☆来收藏吧</p></div>'; return; } 
      const fm = allMessages.filter(m => favorites.has(m.id)); 
      if (fm.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">⭐</div><p>收藏的消息暂时无法显示<br>可能对话数据还未加载</p></div>'; return; } 
      const un = appSettings.userName || '', an = appSettings.aiName || ''; 
      c.innerHTML = fm.map(m => { 
        const isSel = selectedFavMsgIds.has(m.id), mb = m.model ? `<span class="message-model">${formatModelName(m.model)}</span>` : '', avn = m.role === 'user' ? un : an;
        const convIdForJump = m.convId || favorites.get(m.id);
        const avatarContent = m.role === 'user' 
          ? (appSettings.userAvatar ? `<img src="${appSettings.userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🧸')
          : (appSettings.aiAvatar ? `<img src="${appSettings.aiAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🤖');
        return `<div class="message ${m.role}" style="display: flex; align-items: flex-start;"><div class="fav-msg-checkbox ${isFavSelectMode ? 'show' : ''} ${isSel ? 'checked' : ''}" onclick="toggleFavMsgSelection('${m.id}')">${isSel ? '✓' : ''}</div><div class="message-avatar-wrapper"><div class="message-avatar">${avatarContent}</div>${avn ? `<span class="avatar-name">${escapeHtml(avn)}</span>` : ''}</div><div class="message-body"><div class="message-bubble">${escapeHtml(m.content)}</div><div class="message-footer"><span class="message-time">${escapeHtml(m.convTitle)} · ${m.time ? formatFullDateTime(m.time) : ''}</span>${mb}<button class="star-btn active" onclick="toggleFavorite('${m.id}', '${convIdForJump}', this); setTimeout(renderFavorites, 100);">⭐</button>${convIdForJump ? `<button class="fav-jump-btn" onclick="jumpToFavoriteMessage('${convIdForJump}', '${m.id}')">跳转 →</button>` : ''}</div></div></div>`; 
      }).join(''); 
    }
    
    function jumpToFavoriteMessage(convId, msgId) {
      openConversation(convId, null, true);
      setTimeout(() => scrollToMessage(msgId), 300);
    }
    
    function renderCalendar() {
      const c = document.getElementById('calendar-days');
      updateDateLabel();
      const fd = new Date(currentYear, currentMonth, 1).getDay();
      const dim = new Date(currentYear, currentMonth + 1, 0).getDate();
      const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
      const cached = monthStatsCache[monthKey];
      let html = '';
      // 填充空白格子
      for (let i = 0; i < fd; i++) html += '<div class="calendar-day empty"></div>';
      // 渲染每一天
      for (let d = 1; d <= dim; d++) {
        const ds = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const tw = cached?.days?.[ds] || 0;
        let hc = '', wl = '';
        if (tw > 0) {
          wl = formatWordCount(tw);
          if (tw < 5000) hc = 'heat-1';
          else if (tw < 20000) hc = 'heat-2';
          else if (tw < 50000) hc = 'heat-3';
          else hc = 'heat-4';
        }
        html += `<div class="calendar-day ${hc}" onclick="showDayMessages('${ds}')"><span class="day-num">${d}</span>${wl ? `<span class="day-words">${wl}</span>` : ''}</div>`;
      }
      c.innerHTML = html;
      // 使用缓存的统计数据
      const mtw = cached?.totalWords || 0;
      const mad = cached?.activeDays || 0;
      document.getElementById('stat-total-words').textContent = formatWordCount(mtw);
      document.getElementById('stat-total-days').textContent = mad + '天';
      renderWordCloud();
      renderOverview();
    }
    function changeMonth(d) { 
      if (chartMode === 'year') {
        // 年度模式下只切换年份
        currentYear += d;
        updateDateLabel();
        renderYearChart();
      } else {
        currentMonth += d; 
        if (currentMonth < 0) { currentMonth = 11; currentYear--; } 
        else if (currentMonth > 11) { currentMonth = 0; currentYear++; } 
        renderCalendar(); 
        if (chartMode === 'linechart') renderLineChart();
      }
    }
    
    // 图表模式切换
    function setChartMode(mode) {
      chartMode = mode;
      document.getElementById('heatmap-btn').classList.toggle('active', mode === 'heatmap');
      document.getElementById('linechart-btn').classList.toggle('active', mode === 'linechart');
      document.getElementById('yearchart-btn').classList.toggle('active', mode === 'year');
      document.getElementById('calendar-container').style.display = mode === 'heatmap' ? 'block' : 'none';
      document.getElementById('line-chart-container').classList.toggle('show', mode === 'linechart');
      document.getElementById('year-chart-container').classList.toggle('show', mode === 'year');
      // 更新月份/年份标签
      updateDateLabel();
      if (mode === 'linechart') renderLineChart();
      if (mode === 'year') renderYearChart();
    }
    
    function updateDateLabel() {
      const label = document.getElementById('month-label');
      if (chartMode === 'year') {
        label.textContent = `${currentYear}年`;
      } else {
        label.textContent = `${currentYear}年${currentMonth + 1}月`;
      }
    }
    
    // 绘制折线图
    function renderLineChart() {
      const canvas = document.getElementById('line-chart-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();
      
      // 处理设备像素比，解决锯齿问题
      const dpr = window.devicePixelRatio || 1;
      const displayWidth = rect.width - 32;
      const displayHeight = 200;
      canvas.width = displayWidth * dpr;
      canvas.height = displayHeight * dpr;
      canvas.style.width = displayWidth + 'px';
      canvas.style.height = displayHeight + 'px';
      ctx.scale(dpr, dpr);
      
      const dim = new Date(currentYear, currentMonth + 1, 0).getDate();
      const data = [];
      let maxVal = 0;
      for (let d = 1; d <= dim; d++) {
        const ds = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const st = statsByDate[ds];
        const val = st ? (st.userWords + st.aiWords) : 0;
        data.push(val);
        if (val > maxVal) maxVal = val;
      }
      if (maxVal === 0) maxVal = 1000;
      
      const padding = { top: 20, right: 20, bottom: 30, left: 50 };
      const chartW = displayWidth - padding.left - padding.right;
      const chartH = displayHeight - padding.top - padding.bottom;
      
      ctx.clearRect(0, 0, displayWidth, displayHeight);
      
      // 获取主题色
      const style = getComputedStyle(document.body);
      const primaryColor = style.getPropertyValue('--primary').trim() || '#e8b4b8';
      const textColor = style.getPropertyValue('--text-light').trim() || '#8a7a7a';
      const borderColor = style.getPropertyValue('--border').trim() || '#f0e0e0';
      
      // 绘制网格线
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(displayWidth - padding.right, y);
        ctx.stroke();
      }
      
      // 绘制Y轴标签
      ctx.fillStyle = textColor;
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartH / 4) * i;
        const val = Math.round(maxVal * (4 - i) / 4);
        ctx.fillText(formatWordCount(val), padding.left - 8, y + 4);
      }
      
      // 绘制X轴标签
      ctx.textAlign = 'center';
      const step = Math.ceil(dim / 10);
      for (let d = 1; d <= dim; d += step) {
        const x = padding.left + ((d - 1) / (dim - 1)) * chartW;
        ctx.fillText(d + '日', x, displayHeight - 8);
      }
      
      // 绘制折线
      ctx.strokeStyle = primaryColor;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      data.forEach((val, i) => {
        const x = padding.left + (i / (dim - 1)) * chartW;
        const y = padding.top + chartH - (val / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // 绘制数据点
      ctx.fillStyle = primaryColor;
      data.forEach((val, i) => {
        if (val > 0) {
          const x = padding.left + (i / (dim - 1)) * chartW;
          const y = padding.top + chartH - (val / maxVal) * chartH;
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI * 2);
          ctx.closePath();
          ctx.fill();
        }
      });
    }
    
    // 绘制年度柱状图
    function renderYearChart() {
      const canvas = document.getElementById('year-chart-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();
      
      const dpr = window.devicePixelRatio || 1;
      const displayWidth = rect.width - 32;
      const displayHeight = 200;
      canvas.width = displayWidth * dpr;
      canvas.height = displayHeight * dpr;
      canvas.style.width = displayWidth + 'px';
      canvas.style.height = displayHeight + 'px';
      ctx.scale(dpr, dpr);
      
      // 统计每月数据
      const monthData = [];
      let maxVal = 0;
      for (let m = 1; m <= 12; m++) {
        let monthTotal = 0;
        const daysInMonth = new Date(currentYear, m, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const ds = `${currentYear}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const st = statsByDate[ds];
          if (st) monthTotal += st.userWords + st.aiWords;
        }
        monthData.push(monthTotal);
        if (monthTotal > maxVal) maxVal = monthTotal;
      }
      if (maxVal === 0) maxVal = 10000;
      
      const padding = { top: 20, right: 20, bottom: 30, left: 50 };
      const chartW = displayWidth - padding.left - padding.right;
      const chartH = displayHeight - padding.top - padding.bottom;
      
      ctx.clearRect(0, 0, displayWidth, displayHeight);
      
      const style = getComputedStyle(document.body);
      const primaryColor = style.getPropertyValue('--primary').trim() || '#e8b4b8';
      const primaryLightColor = style.getPropertyValue('--primary-light').trim() || '#f5d5d8';
      const textColor = style.getPropertyValue('--text-light').trim() || '#8a7a7a';
      const borderColor = style.getPropertyValue('--border').trim() || '#f0e0e0';
      
      // 绘制网格线
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartH / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(displayWidth - padding.right, y);
        ctx.stroke();
      }
      
      // 绘制Y轴标签
      ctx.fillStyle = textColor;
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartH / 4) * i;
        const val = Math.round(maxVal * (4 - i) / 4);
        ctx.fillText(formatWordCount(val), padding.left - 8, y + 4);
      }
      
      // 绘制柱状图
      const barWidth = (chartW - 24) / 12;
      const gap = 2;
      monthData.forEach((val, i) => {
        const x = padding.left + i * barWidth + gap;
        const barH = (val / maxVal) * chartH;
        const y = padding.top + chartH - barH;
        
        // 绘制柱子
        ctx.fillStyle = val > 0 ? primaryColor : primaryLightColor;
        ctx.beginPath();
        ctx.roundRect(x, y, barWidth - gap * 2, barH, 4);
        ctx.fill();
        
        // 绘制月份标签
        ctx.fillStyle = textColor;
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText((i + 1) + '月', x + (barWidth - gap * 2) / 2, displayHeight - 8);
      });
    }
    
    // 更新窗口筛选下拉框
    function updateConvFilterOptions() {
      const select = document.getElementById('wordcloud-conv-filter');
      if (!select) return;
      select.innerHTML = '<option value="all">全部窗口</option>';
      allConversations.forEach(conv => {
        const title = (conv.title || '未命名对话').substring(0, 15) + ((conv.title || '').length > 15 ? '...' : '');
        select.innerHTML += `<option value="${conv.id}">${escapeHtml(title)}</option>`;
      });
    }
    
    // 正向最大匹配分词
    function segmentChinese(text, hideEnglish = false) {
      const words = new Map();
      
      // 如果词典加载成功，使用正向最大匹配
      if (dictLoaded && wordDict.size > 0) {
        // 提取所有中文片段
        const chineseSegments = text.match(/[\u4e00-\u9fa5]+/g) || [];
        
        for (const segment of chineseSegments) {
          let i = 0;
          while (i < segment.length) {
            let matched = false;
            // 从最长的词开始匹配（最大5个字）
            for (let len = Math.min(5, segment.length - i); len >= 2; len--) {
              const word = segment.substring(i, i + len);
              if (wordDict.has(word)) {
                // 找到词典中的词
                if (!STOPWORDS.has(word) && !wordcloudBlacklist.includes(word)) {
                  words.set(word, (words.get(word) || 0) + 1);
                }
                i += len;
                matched = true;
                break;
              }
            }
            // 如果没有匹配到，跳过一个字
            if (!matched) {
              i++;
            }
          }
        }
      } else {
        // 词典未加载，使用简单的2-4字提取（备用方案）
        const chineseRegex = /[\u4e00-\u9fa5]{2,4}/g;
        let match;
        while ((match = chineseRegex.exec(text)) !== null) {
          const word = match[0];
          if (!STOPWORDS.has(word) && !wordcloudBlacklist.includes(word)) {
            words.set(word, (words.get(word) || 0) + 1);
          }
        }
      }
      
      // 提取英文单词(3字母以上)
      if (!hideEnglish) {
        const englishRegex = /[a-zA-Z]{3,}/g;
        let match;
        while ((match = englishRegex.exec(text)) !== null) {
          const word = match[0].toLowerCase();
          if (!STOPWORDS.has(word) && !wordcloudBlacklist.includes(word)) {
            words.set(word, (words.get(word) || 0) + 1);
          }
        }
      }
      
      return words;
    }
    
    // 渲染词云
    function renderWordCloud() {
      const container = document.getElementById('wordcloud-container');
      if (!container) return;
      
      const convFilter = document.getElementById('wordcloud-conv-filter')?.value || 'all';
      const dateFilter = document.getElementById('wordcloud-date-filter')?.value || 'all';
      const roleFilter = document.getElementById('wordcloud-role-filter')?.value || 'all';
      const hideEnglish = document.getElementById('wordcloud-hide-english')?.checked || false;
      
      // 筛选消息 - 根据角色筛选
      let filteredMsgs = allMessages.filter(m => m.type === 'normal');
      
      if (roleFilter === 'user') {
        filteredMsgs = filteredMsgs.filter(m => m.role === 'user');
      } else if (roleFilter === 'assistant') {
        filteredMsgs = filteredMsgs.filter(m => m.role === 'assistant');
      }
      
      if (convFilter !== 'all') {
        filteredMsgs = filteredMsgs.filter(m => m.convId === convFilter);
      }
      
      if (dateFilter === 'month') {
        const monthStart = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`;
        const monthEnd = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-31`;
        filteredMsgs = filteredMsgs.filter(m => {
          if (!m.time) return false;
          const ds = formatDateKey(m.time);
          return ds >= monthStart && ds <= monthEnd;
        });
      }
      
      if (filteredMsgs.length === 0) {
        container.innerHTML = '<span class="wordcloud-empty">暂无数据</span>';
        return;
      }
      
      // 合并所有文本并分词
      const allText = filteredMsgs.map(m => m.content).join(' ');
      const wordCounts = segmentChinese(allText, hideEnglish);
      
      if (wordCounts.size === 0) {
        container.innerHTML = '<span class="wordcloud-empty">暂无高频词</span>';
        return;
      }
      
      // 排序并取前50个
      const sorted = Array.from(wordCounts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 50);
      const maxCount = sorted[0][1];
      const minCount = sorted[sorted.length - 1][1];
      
      // 渲染词云 - 点击显示删除按钮，再点删除才加黑名单
      container.innerHTML = sorted.map(([word, count]) => {
        let sizeClass;
        const ratio = (count - minCount) / (maxCount - minCount + 1);
        if (ratio > 0.8) sizeClass = 'size-5';
        else if (ratio > 0.6) sizeClass = 'size-4';
        else if (ratio > 0.4) sizeClass = 'size-3';
        else if (ratio > 0.2) sizeClass = 'size-2';
        else sizeClass = 'size-1';
        return `<span class="wordcloud-word ${sizeClass}" data-word="${escapeHtml(word)}" onclick="toggleWordDeleteBtn(this)" title="${count}次"><span class="word-text">${escapeHtml(word)}</span><span class="word-delete-btn" onclick="event.stopPropagation(); confirmAddToBlacklist('${escapeJsString(word)}', this.parentElement)">×</span></span>`;
      }).join('');
    }
    
    // 聊天总览渲染
    function renderOverview() {
      renderTotalStats();
      renderOverviewSummary();
      renderTopDays();
      renderTopConversations();
    }

    // 总数据统计渲染
    function renderTotalStats() {
      // 获取设置的名字，如果没有则使用默认值
      const userName = (appSettings && appSettings.userName) ? appSettings.userName : '用户';
      const aiName = (appSettings && appSettings.aiName) ? appSettings.aiName : '助手';

      // 更新名字显示
      const userNameEl = document.getElementById('total-user-name');
      const aiNameEl = document.getElementById('total-ai-name');
      if (userNameEl) userNameEl.textContent = userName;
      if (aiNameEl) aiNameEl.textContent = aiName;

      // 更新头像
      const userAvatarEl = document.getElementById('total-user-avatar');
      const aiAvatarEl = document.getElementById('total-ai-avatar');
      if (userAvatarEl) {
        userAvatarEl.innerHTML = (appSettings && appSettings.userAvatar)
          ? `<img src="${appSettings.userAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🧸';
      }
      if (aiAvatarEl) {
        aiAvatarEl.innerHTML = (appSettings && appSettings.aiAvatar)
          ? `<img src="${appSettings.aiAvatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : '🤖';
      }

      // 计算统计数据
      let userWords = 0, aiWords = 0, userMsgs = 0, aiMsgs = 0;
      allMessages.forEach(msg => {
        if (msg.type && msg.type !== 'normal') return;
        const words = msg.content ? msg.content.length : 0;
        if (msg.role === 'user') {
          userWords += words;
          userMsgs++;
        } else if (msg.role === 'assistant') {
          aiWords += words;
          aiMsgs++;
        }
      });

      const userAvg = userMsgs > 0 ? Math.round(userWords / userMsgs) : 0;
      const aiAvg = aiMsgs > 0 ? Math.round(aiWords / aiMsgs) : 0;

      // 更新数据显示
      const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      setVal('total-user-words', userWords.toLocaleString() + ' 字');
      setVal('total-user-msgs', userMsgs.toLocaleString() + ' 条');
      setVal('total-user-avg', userAvg.toLocaleString() + ' 字');
      setVal('total-ai-words', aiWords.toLocaleString() + ' 字');
      setVal('total-ai-msgs', aiMsgs.toLocaleString() + ' 条');
      setVal('total-ai-avg', aiAvg.toLocaleString() + ' 字');
    }

    function renderOverviewSummary() {
      const textEl = document.getElementById('overview-text');
      if (!textEl || allMessages.length === 0) {
        if (textEl) textEl.innerHTML = '还没有聊天记录哦~';
        return;
      }
      
      // 获取所有有消息的日期
      const dates = Object.keys(statsByDate).sort();
      if (dates.length === 0) {
        textEl.innerHTML = '还没有聊天记录哦~';
        return;
      }
      
      const firstDate = dates[0];
      const lastDate = dates[dates.length - 1];
      const firstDateObj = new Date(firstDate);
      const lastDateObj = new Date(lastDate);
      const totalDays = Math.floor((lastDateObj - firstDateObj) / (1000 * 60 * 60 * 24)) + 1;
      const chatDays = dates.length;
      
      // 计算总字数
      let totalWords = 0;
      dates.forEach(ds => {
        const st = statsByDate[ds];
        if (st) totalWords += st.userWords + st.aiWords;
      });
      const avgWordsPerDay = chatDays > 0 ? Math.round(totalWords / chatDays) : 0;
      
      // 计算最长连续聊天天数
      let maxStreak = 1, currentStreak = 1;
      for (let i = 1; i < dates.length; i++) {
        const prevDate = new Date(dates[i - 1]);
        const currDate = new Date(dates[i]);
        const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
        if (diffDays === 1) {
          currentStreak++;
          if (currentStreak > maxStreak) maxStreak = currentStreak;
        } else {
          currentStreak = 1;
        }
      }
      
      // 统计每个小时的消息数量，找出最活跃时段
      const hourCounts = new Array(24).fill(0);
      let totalMsgCount = 0;
      allMessages.forEach(msg => {
        if (msg.time && (msg.type === 'normal' || !msg.type)) {
          const hour = new Date(msg.time * 1000).getHours();
          hourCounts[hour]++;
          totalMsgCount++;
        }
      });
      
      // 找出连续3小时最活跃的时段
      let maxHourSum = 0, peakStartHour = 0;
      for (let i = 0; i < 24; i++) {
        const sum = hourCounts[i] + hourCounts[(i + 1) % 24] + hourCounts[(i + 2) % 24];
        if (sum > maxHourSum) {
          maxHourSum = sum;
          peakStartHour = i;
        }
      }
      const peakEndHour = (peakStartHour + 3) % 24;
      const peakPercent = totalMsgCount > 0 ? Math.round(maxHourSum / totalMsgCount * 100) : 0;
      const peakTimeStr = `${String(peakStartHour).padStart(2, '0')}:00–${String(peakEndHour).padStart(2, '0')}:00`;
      
      const firstDateStr = `${firstDateObj.getFullYear()}年${firstDateObj.getMonth() + 1}月${firstDateObj.getDate()}日`;
      const lastDateStr = `${lastDateObj.getFullYear()}年${lastDateObj.getMonth() + 1}月${lastDateObj.getDate()}日`;
      
      textEl.innerHTML = `我们从 <span class="highlight-num">${firstDateStr}</span> 聊到 <span class="highlight-num">${lastDateStr}</span>，共同走过了 <span class="highlight-num">${totalDays}</span> 天。<br>这期间，有 <span class="highlight-num">${chatDays}</span> 天都有我们的对话，每个活跃日平均要说上 <span class="highlight-num">${avgWordsPerDay.toLocaleString()}</span> 字。<br>我们最喜欢在 <span class="highlight-num">${peakTimeStr}</span> 谈话，那段时光占据了所有对话的 <span class="highlight-num">${peakPercent}%</span>。<br>最长的一次，我们连续聊了 <span class="highlight-num">${maxStreak}</span> 天都没有停下。`;
    }
    
    function renderTopDays() {
      const container = document.getElementById('top-days-list');
      if (!container) return;
      
      // 按字数排序日期
      const dayStats = Object.entries(statsByDate).map(([date, st]) => ({
        date,
        words: st.userWords + st.aiWords,
        count: st.count
      })).sort((a, b) => b.words - a.words).slice(0, 10);
      
      if (dayStats.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);">暂无数据</div>';
        return;
      }
      
      container.innerHTML = dayStats.map((item, i) => {
        return `<div class="ranking-item" onclick="showDayMessages('${item.date}')">
          <span class="rank-num">#${i + 1}</span>
          <div class="rank-info">
            <div class="rank-title">${formatDateFromKey(item.date)}</div>
            <div class="rank-meta">${formatWordCount(item.words)} · ${item.count}条消息</div>
          </div>
        </div>`;
      }).join('');
    }
    
    function renderTopConversations() {
      const container = document.getElementById('top-convs-list');
      if (!container) return;
      
      // 按字数排序对话
      const convStats = allConversations.map(conv => {
        const stats = conversationStats[conv.id] || { totalChars: 0, messageCount: 0 };
        return {
          id: conv.id,
          title: conv.title || '未命名对话',
          words: stats.totalChars,
          count: stats.messageCount
        };
      }).sort((a, b) => b.words - a.words).slice(0, 10);
      
      if (convStats.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);">暂无数据</div>';
        return;
      }
      
      container.innerHTML = convStats.map((item, i) => {
        const shortTitle = item.title.length > 15 ? item.title.substring(0, 15) + '...' : item.title;
        return `<div class="ranking-item" onclick="openConversation('${item.id}')">
          <span class="rank-num">#${i + 1}</span>
          <div class="rank-info">
            <div class="rank-title">${escapeHtml(shortTitle)}</div>
            <div class="rank-meta">${formatNumber(item.words)}字 · ${item.count}条消息</div>
          </div>
        </div>`;
      }).join('');
    }
    
    function randomJumpToMoment() {
      // 筛选出所有普通消息（排除系统消息和记忆消息）
      const normalMessages = allMessages.filter(m => m.type === 'normal' || !m.type);
      if (normalMessages.length === 0) {
        showToast('还没有聊天记录哦');
        return;
      }
      // 随机选择一条消息
      const randomMsg = normalMessages[Math.floor(Math.random() * normalMessages.length)];
      const convId = randomMsg.convId;
      const msgId = randomMsg.id;
      
      // 打开对话并定位到那条消息
      openConversation(convId, null, true);
      setTimeout(() => scrollToMessage(msgId), 300);
      
      // 显示提示
      const timeStr = randomMsg.time ? formatFullDateTime(randomMsg.time) : '';
      const roleStr = randomMsg.role === 'user' ? '你说的' : 'AI说的';
      showToast(`🎲 随机到了 ${timeStr} ${roleStr}一句话~`);
    }
    
    function showDayMessages(ds) { 
      const dm = messagesByDate[ds]; 
      if (!dm || dm.length === 0) { showToast('这天没有消息'); return; }
      const convMap = new Map();
      dm.forEach(msg => {
        if (!convMap.has(msg.convId)) { convMap.set(msg.convId, { convId: msg.convId, convTitle: msg.convTitle, messageCount: 0, userCount: 0, aiCount: 0 }); }
        const info = convMap.get(msg.convId);
        info.messageCount++;
        if (msg.role === 'user') info.userCount++; else if (msg.role === 'assistant') info.aiCount++;
      });
      const convList = Array.from(convMap.values());
      document.getElementById('conv-select-title').textContent = formatDateFromKey(ds);
      document.getElementById('conv-select-subtitle').textContent = `共 ${convList.length} 个对话窗口，${dm.length} 条消息`;
      const container = document.getElementById('conv-select-list');
      container.innerHTML = convList.map(conv => {
        return `<div class="conv-select-item" onclick="showConvMessagesForDate('${ds}', '${conv.convId}')"><div class="conv-icon">💬</div><div class="conv-detail"><div class="conv-name">${escapeHtml(conv.convTitle)}</div><div class="conv-stats">${conv.messageCount} 条消息 · 用户 ${conv.userCount} 条 · AI ${conv.aiCount} 条</div></div><div class="conv-arrow">›</div></div>`;
      }).join('');
      window.currentSelectedDate = ds;
      switchView('conv-select'); 
    }

    function showConvMessagesForDate(ds, convId) {
      const dm = messagesByDate[ds];
      if (!dm || dm.length === 0) { showToast('没有找到消息'); return; }
      const filteredMessages = dm.filter(msg => msg.convId === convId);
      if (filteredMessages.length === 0) { showToast('该窗口在这天没有消息'); return; }
      filteredMessages.sort((a, b) => (a.time || 0) - (b.time || 0));
      const convTitle = filteredMessages[0].convTitle || '未命名对话';
      document.getElementById('day-messages-title').textContent = `${formatDateFromKey(ds)}`;
      document.getElementById('day-messages-subtitle').textContent = `${convTitle} · 共 ${filteredMessages.length} 条消息`;
      renderMessages(filteredMessages, document.getElementById('day-messages-container'), false);
      window.currentSelectedDate = ds;
      window.currentSelectedConvId = convId;
      switchView('day-messages');
      applyPattern();
    }

    function backToConvSelect() { if (window.currentSelectedDate) { showDayMessages(window.currentSelectedDate); } else { switchView('timeline'); } }
    
    function renderTimeline() { const c = document.getElementById('timeline-list'), dates = Object.keys(statsByDate).sort().reverse(); if (dates.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">📅</div><p>还没有对话数据~</p></div>'; return; } c.innerHTML = dates.map(d => { const st = statsByDate[d], total = st.userWords + st.aiWords; return `<div class="timeline-date-item" onclick="showDayMessages('${d}')"><span class="date">${formatDateFromKey(d)}</span><span class="count">${st.count}条消息 · ${formatWordCount(total)}</span></div>`; }).join(''); }
    
    function switchView(view) { 
      document.querySelectorAll('.drawer-menu-item').forEach(el => el.classList.toggle('active', el.dataset.view === view)); 
      document.getElementById('view-upload').style.display = 'none'; 
      document.getElementById('view-chat').classList.remove('show'); 
      document.getElementById('view-favorites').classList.remove('show'); 
      document.getElementById('view-stats').classList.remove('show'); 
      document.getElementById('view-timeline').classList.remove('show'); 
      document.getElementById('view-day-messages').classList.remove('show'); 
      document.getElementById('view-global-search').classList.remove('show'); 
      document.getElementById('view-conv-select').classList.remove('show');
      switch(view) { 
        case 'conversations': 
          if (currentConvId) document.getElementById('view-chat').classList.add('show'); 
          else if (allConversations.length > 0) openConversation(allConversations[0].id); 
          else document.getElementById('view-upload').style.display = 'flex'; 
          break; 
        case 'chat': document.getElementById('view-chat').classList.add('show'); break; 
        case 'favorites': document.getElementById('view-favorites').classList.add('show'); renderFavorites(); break; 
        case 'stats': document.getElementById('view-stats').classList.add('show'); break; 
        case 'timeline': document.getElementById('view-timeline').classList.add('show'); break; 
        case 'day-messages': document.getElementById('view-day-messages').classList.add('show'); break; 
        case 'conv-select': document.getElementById('view-conv-select').classList.add('show'); break;
      } 
      toggleDrawer(false); 
    }
    
    function toggleDrawer(show) { const d = document.getElementById('drawer'), o = document.getElementById('drawer-overlay'); if (typeof show === 'undefined') show = !d.classList.contains('show'); d.classList.toggle('show', show); o.classList.toggle('show', show); }
    function updateDrawerSubtitle() { const s = document.getElementById('drawer-subtitle'); s.textContent = allConversations.length > 0 ? `${allConversations.length} 个对话 · ${allMessages.length} 条消息` : '还没有上传对话哦~'; }
    function showModal(icon, title, message, onConfirm, isDanger = false) { document.getElementById('modal-icon').textContent = icon; document.getElementById('modal-title').textContent = title; document.getElementById('modal-message').textContent = message; document.getElementById('modal-confirm-btn').className = isDanger ? 'modal-btn confirm' : 'modal-btn primary'; modalConfirmCallback = onConfirm; document.getElementById('modal-overlay').classList.add('show'); }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); modalConfirmCallback = null; }
    async function confirmModalAction() { if (modalConfirmCallback) { const cb = modalConfirmCallback; closeModal(); await cb(); } }
    function showClearDataModal() { showModal('⚠️', '清除所有数据', '确定要清除所有数据吗？\n这将删除所有对话和收藏，无法恢复！', async () => { showLoading('正在清除数据...'); try { await clearAllDataFromDb(); allConversations = []; filteredConversations = []; allMessages = []; messagesByDate = {}; favorites = new Map(); statsByDate = {}; conversationStats = {}; currentConvId = null; currentConvIndex = -1; currentMessages = []; renderConversationList(); updateDrawerSubtitle(); document.getElementById('view-upload').style.display = 'flex'; document.getElementById('view-chat').classList.remove('show'); toggleDrawer(false); showToast('已清除所有数据'); } catch (e) { console.error('清除失败', e); showToast('清除失败，请重试'); } hideLoading(); }, true); }
    function showLoading(text) { document.getElementById('loading-text').textContent = text || '加载中...'; document.getElementById('loading-overlay').classList.add('show'); }
    function hideLoading() { document.getElementById('loading-overlay').classList.remove('show'); }
    function showToast(message) { const t = document.getElementById('toast'); t.textContent = message; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    function formatDate(ts) { return new Date(ts * 1000).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }); }
    function formatDateCompact(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`; }
    function formatFullDateTime(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
    function formatDateKey(ts) { const d = new Date(ts * 1000); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
    function formatDateShort(ds) { const [y, m, d] = ds.split('-'); return `${parseInt(m)}/${parseInt(d)}`; }
    function formatDateFromKey(ds) { const [y, m, d] = ds.split('-'); return `${y}年${parseInt(m)}月${parseInt(d)}日`; }
    function formatDateForFile(d) { return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`; }
    function formatWordCount(c) { if (c >= 10000) return (c / 10000).toFixed(1) + 'w'; if (c >= 1000) return (c / 1000).toFixed(1) + 'k'; return c.toString(); }
    function formatNumber(n) { if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M'; if (n >= 1000) return (n / 1000).toFixed(1) + 'k'; return n.toString(); }
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
  </script>
</body>
</html>
